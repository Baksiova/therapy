<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terapeutick√Ω Asistent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color-start: #6D5BBA;
            --primary-color-end: #8D58BF;
            --secondary-bg: #f5f7fa;
            --body-bg-start: #e0eafc;
            --body-bg-end: #cfdef3;
            --text-color-light: #ffffff;
            --text-color-dark: #333333;
            --border-color: #e0e0e0;
            --font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 20px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--body-bg-start) 0%, var(--body-bg-end) 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            background: var(--text-color-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light);
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }

        .chat-header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-header .chat-subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
        }

        .new-session-btn {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color-light); padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-size: 12px; font-family: var(--font-family);
            transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;
        }
        .new-session-btn:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-52%); }

        .status-indicator {
            position: absolute; top: 15px; left: 20px; padding: 4px 10px;
            border-radius: 12px; font-size: 11px; font-weight: 500;
            background: rgba(0, 0, 0, 0.2); color: var(--text-color-light); transition: all 0.3s ease;
        }
        .status-indicator.connected { background: #2ecc71; }
        .status-indicator.disconnected { background: #e74c3c; }
        .status-indicator.connecting { background: #f1c40f; }

        .app-main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; 
            flex-direction: column;
            background: var(--secondary-bg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .view.active {
            opacity: 1;
            visibility: visible;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 20px; display: flex; align-items: flex-end;
            gap: 10px; animation: slideIn 0.4s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .message-content {
            max-width: 75%; padding: 12px 18px; border-radius: var(--border-radius);
            word-wrap: break-word; line-height: 1.5; font-weight: 400;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light); border-bottom-right-radius: 5px;
        }
        .message.bot .message-content {
            background: var(--text-color-light); color: var(--text-color-dark); border-bottom-left-radius: 5px;
            white-space: pre-wrap;
        }
        .message-avatar {
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); background: #fff;
        }
        .message-avatar svg { width: 20px; height: 20px; fill: var(--primary-color-start); }
        .message.user .message-avatar { order: 1; }
        
        .chat-input-container {
            padding: 15px 20px; background: var(--text-color-light);
            border-top: 1px solid var(--border-color);
        }
        .chat-input-form { display: flex; gap: 10px; align-items: center; }
        .chat-input {
            flex: 1; padding: 14px 20px; border: 1px solid var(--border-color);
            border-radius: 30px; font-size: 16px; font-family: var(--font-family);
            outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .chat-input:focus { border-color: var(--primary-color-start); box-shadow: 0 0 0 3px rgba(109, 91, 186, 0.15); }
        .chat-input:disabled { background: #f5f5f5; cursor: not-allowed; }
        
        .send-button {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light); border: none; width: 50px; height: 50px;
            border-radius: 50%; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .send-button svg { width: 24px; height: 24px; }
        .send-button:hover:not(:disabled) { transform: scale(1.1); }
        .send-button:disabled { opacity: 0.6; cursor: not-allowed; transform: scale(1); }

        .typing-indicator { display: none; align-items: center; margin: 0 20px 20px; gap: 10px; }
        .typing-dots { background: var(--text-color-light); border-radius: 18px; padding: 14px 18px; display: flex; gap: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .error-message { background: #fff0f0; color: #c0392b; padding: 12px; border-radius: 10px; margin: 0 20px 15px; border-left: 4px solid #e74c3c; animation: slideIn 0.3s ease-out; font-size: 14px; }
        .welcome-message { text-align: center; color: #777; padding: 15px; font-size: 14px; }

        #toolsView {
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            align-content: start;
        }
        .tool-card {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(109, 91, 186, 0.15);
        }
        .tool-card-icon {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .tool-card-icon svg { fill: var(--text-color-light); width: 28px; height: 28px; }
        .tool-card-content h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--text-color-dark); }
        .tool-card-content p { font-size: 14px; color: #666; }

        .app-nav {
            display: flex;
            background: #fff;
            border-top: 1px solid var(--border-color);
            padding: 8px 0;
            flex-shrink: 0;
        }
        .nav-btn {
            flex: 1; background: none; border: none;
            color: #999;
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; cursor: pointer;
            transition: color 0.3s ease;
            font-family: var(--font-family);
        }
        .nav-btn.active, .nav-btn:hover {
            color: var(--primary-color-start);
        }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .nav-btn span { font-size: 11px; font-weight: 500; }

        /* Breathing Exercise Overlay */
        .breathing-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .breathing-container {
            text-align: center;
            color: white;
            max-width: 500px;
            padding: 40px;
            position: relative;
        }

        .breathing-circle {
            width: 300px;
            height: 300px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            margin: 0 auto 40px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .breathing-inner-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 0 30px rgba(109, 91, 186, 0.5);
        }

        .breathing-inner-circle.inhale {
            transform: scale(3.5);
        }

        .breathing-inner-circle.hold {
            transform: scale(3.5);
        }

        .breathing-inner-circle.exhale {
            transform: scale(1);
        }

        .breathing-instructions {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .breathing-counter {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .breathing-progress {
            margin-bottom: 30px;
        }

        .breathing-progress-text {
            font-size: 16px;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .breathing-progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .breathing-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            width: 0%;
            transition: width 0.3s ease;
        }

        .breathing-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }

        .breathing-btn {
            padding: 12px 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-family: var(--font-family);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .breathing-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .breathing-btn.primary {
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            border-color: transparent;
        }

        .breathing-technique-selector {
            margin-bottom: 30px;
        }

        .technique-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .technique-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-family: var(--font-family);
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .technique-btn.active {
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            border-color: transparent;
        }

        /* Stress Tracking Overlay */
        .stress-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .stress-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .stress-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .stress-header h2 {
            color: var(--text-color-dark);
            font-size: 24px;
            margin-bottom: 10px;
        }

        .stress-header p {
            color: #666;
            font-size: 14px;
        }

        .stress-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .stress-question {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stress-question label {
            font-weight: 600;
            color: var(--text-color-dark);
            font-size: 16px;
        }

        .stress-scale {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .stress-scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .stress-number {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
        }

        .stress-number:hover {
            border-color: var(--primary-color-start);
            transform: scale(1.1);
        }

        .stress-number.selected {
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            color: white;
            border-color: var(--primary-color-start);
        }

        .stress-textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-family: var(--font-family);
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .stress-textarea:focus {
            border-color: var(--primary-color-start);
            box-shadow: 0 0 0 3px rgba(109, 91, 186, 0.15);
        }

        .stress-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .stress-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-family: var(--font-family);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .stress-btn.primary {
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            color: white;
        }

        .stress-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(109, 91, 186, 0.3);
        }

        .stress-btn.secondary {
            background: #f5f5f5;
            color: var(--text-color-dark);
            border: 1px solid var(--border-color);
        }

        .stress-btn.secondary:hover {
            background: #e0e0e0;
        }

        /* Dashboard View */
        .dashboard-view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--secondary-bg);
            display: none;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .dashboard-view.active {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        #dashboardView {
            padding: 20px;
            overflow-y: auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .dashboard-header h2 {
            color: var(--text-color-dark);
            font-size: 24px;
            margin-bottom: 10px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 600;
            color: var(--primary-color-start);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color-dark);
            margin-bottom: 15px;
        }

        .chart-placeholder {
            height: 200px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
        }

        .stress-history {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-size: 14px;
            color: #666;
        }

        .history-score {
            font-size: 16px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
        }

        .history-score.low { background: #2ecc71; }
        .history-score.medium { background: #f39c12; }
        .history-score.high { background: #e74c3c; }

        @media (max-width: 768px) {
            .stress-container { padding: 20px; }
            .stress-scale { flex-wrap: wrap; gap: 8px; }
            .stress-number { width: 35px; height: 35px; font-size: 14px; }
            .dashboard-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="chat-header">
            <div class="status-indicator connecting" id="statusIndicator">Connecting...</div>
            <h1 id="headerTitle">üå± V√°≈° Terapeutick√Ω Asistent</h1>
            <p id="headerSubtitle" class="chat-subtitle">Bezpeƒçn√Ω priestor pre va≈°e my≈°lienky</p>
            <button class="new-session-btn" onclick="startNewSession()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                <span id="newSessionText">New Session</span>
            </button>
        </div>

        <main class="app-main-content">
            <div id="chatView" class="view active">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">Vitajte. V≈°etko, ƒço tu zdieƒæate, je d√¥vern√©.</div>
                    <div class="message bot">
                        <div class="message-avatar">
                            <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,1,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>
                        </div>
                        <div class="message-content">Dobr√Ω de≈à! Som tu, aby som v√°s poƒç√∫val a podporil. Ako sa dnes c√≠tite?</div>
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">
                        <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>
                    </div>
                    <div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                </div>
                <div class="chat-input-container">
                    <form class="chat-input-form" onsubmit="sendMessage(event)">
                        <input type="text" class="chat-input" id="messageInput" placeholder="Nap√≠≈°te svoju spr√°vu..." maxlength="500" autocomplete="off" disabled>
                        <button type="submit" class="send-button" id="sendButton" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div id="toolsView" class="view">
                <div class="tool-card" onclick="startBreathingExercise()">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.2,19H12.8C13.9,19 14.8,18.1 14.8,17V15H9.2V17C9.2,18.1 10.1,19 11.2,19H11.8V19.5C11.8,19.8 12,20 12.3,20S12.8,19.8 12.8,19.5V19M19.7,9.8C19.4,9.5 19,9.3 18.5,9.3H15.3V6.8C15.3,6.3 14.8,5.9 14.3,5.9S13.3,6.3 13.3,6.8V9.3H10.8V4.8C10.8,4.3 10.3,3.9 9.8,3.9S8.8,4.3 8.8,4.8V9.3H5.5C5,9.3 4.6,9.5 4.3,9.8C4,10.1 3.9,10.6 4.1,11L8.1,14.3H15.9L19.9,11C20.1,10.6 20,10.1 19.7,9.8Z" /></svg></div>
                    <div class="tool-card-content"><h3>Hlbok√Ω n√°dych</h3><p>5-min√∫tov√© cviƒçenie na okam≈æit√© upokojenie.</p></div>
                </div>
                <div class="tool-card" onclick="startStressTracking()">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M14.5,9A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 14.5,12A1.5,1.5 0 0,1 13,10.5A1.5,1.5 0 0,1 14.5,9M9.5,9A1.5,1.5 0 0,1 11,10.5A1.5,1.5 0 0,1 9.5,12A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 9.5,9M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23Z" /></svg></div>
                    <div class="tool-card-content"><h3>Denn√Ω Stress Tracker</h3><p>Hodnotenie stresu v pr√°ci + osobn√Ω dashboard trendov.</p></div>
                </div>
                 <div class="tool-card" onclick="alert('Sp√∫≈°≈•am medit√°ciu...')">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21,12C21,16.97 16.97,21 12,21C7.03,21 3,16.97 3,12C3,7.03 7.03,3 12,3C12.54,3 13.07,3.05 13.58,3.14L12,7L10.42,3.14C10.93,3.05 11.46,3 12,3M12,19C15.87,19 19,15.87 19,12C19,8.13 15.87,5 12,5C8.13,5 5,8.13 5,12C5,15.87 8.13,19 12,19M8.5,12.5L12,6L15.5,12.5H8.5M15.5,14.5L12,18L8.5,14.5H15.5Z" /></svg></div>
                    <div class="tool-card-content"><h3>Skenovanie tela</h3><p>10-min√∫tov√° riaden√° medit√°cia na uvoƒænenie.</p></div>
                </div>
            </div>
                <div class="dashboard-header">
                    <h2>üìä V√°≈° Stress Dashboard</h2>
                    <p>Prehƒæad va≈°ich stress trendov a wellbeing metr√≠k</p>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="avgStressLevel">-</div>
                        <div class="stat-label">Priemern√Ω stress (7 dn√≠)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEntries">0</div>
                        <div class="stat-label">Celkom z√°znamov</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="streakDays">0</div>
                        <div class="stat-label">Dni v rade</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="trendIndicator">üìà</div>
                        <div class="stat-label">Trend t√Ω≈æde≈à</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Stress Level Trendy (Posledn√Ωch 30 dn√≠)</div>
                    <div class="chart-placeholder" id="stressChart">
                        üìà Graf stress trendov sa zobraz√≠ po prv√Ωch z√°znamoch
                    </div>
                </div>

                <div class="stress-history">
                    <h3 class="chart-title">Ned√°vne z√°znamy</h3>
                    <div id="stressHistoryList">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            Zatiaƒæ ≈æiadne z√°znamy. Zaƒçnite sledova≈• svoj stress!
                        </div>
                    </div>
                </div>

                <div class="stress-actions" style="margin-top: 20px;">
                    <button class="stress-btn primary" onclick="startStressTracking()">+ Nov√Ω z√°znam</button>
                    <button class="stress-btn secondary" onclick="exportStressData()">üìä Export d√°t</button>
                </div>
            </div>
                <div class="tool-card" onclick="startBreathingExercise()">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.2,19H12.8C13.9,19 14.8,18.1 14.8,17V15H9.2V17C9.2,18.1 10.1,19 11.2,19H11.8V19.5C11.8,19.8 12,20 12.3,20S12.8,19.8 12.8,19.5V19M19.7,9.8C19.4,9.5 19,9.3 18.5,9.3H15.3V6.8C15.3,6.3 14.8,5.9 14.3,5.9S13.3,6.3 13.3,6.8V9.3H10.8V4.8C10.8,4.3 10.3,3.9 9.8,3.9S8.8,4.3 8.8,4.8V9.3H5.5C5,9.3 4.6,9.5 4.3,9.8C4,10.1 3.9,10.6 4.1,11L8.1,14.3H15.9L19.9,11C20.1,10.6 20,10.1 19.7,9.8Z" /></svg></div>
                    <div class="tool-card-content"><h3>Hlbok√Ω n√°dych</h3><p>5-min√∫tov√© cviƒçenie na okam≈æit√© upokojenie.</p></div>
                </div>
                <div class="tool-card" onclick="startStressTracking()">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M14.5,9A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 14.5,12A1.5,1.5 0 0,1 13,10.5A1.5,1.5 0 0,1 14.5,9M9.5,9A1.5,1.5 0 0,1 11,10.5A1.5,1.5 0 0,1 9.5,12A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 9.5,9M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23Z" /></svg></div>
                    <div class="tool-card-content"><h3>Denn√Ω Stress Tracker</h3><p>Hodnotenie stresu v pr√°ci + osobn√Ω dashboard trendov.</p></div>
                </div>
                 <div class="tool-card" onclick="alert('Sp√∫≈°≈•am medit√°ciu...')">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21,12C21,16.97 16.97,21 12,21C7.03,21 3,16.97 3,12C3,7.03 7.03,3 12,3C12.54,3 13.07,3.05 13.58,3.14L12,7L10.42,3.14C10.93,3.05 11.46,3 12,3M12,19C15.87,19 19,15.87 19,12C19,8.13 15.87,5 12,5C8.13,5 5,8.13 5,12C5,15.87 8.13,19 12,19M8.5,12.5L12,6L15.5,12.5H8.5M15.5,14.5L12,18L8.5,14.5H15.5Z" /></svg></div>
                    <div class="tool-card-content"><h3>Skenovanie tela</h3><p>10-min√∫tov√° riaden√° medit√°cia na uvoƒænenie.</p></div>
                </div>
            </div>
        </main>

        <nav class="app-nav">
            <button class="nav-btn active" data-view="chatView" data-title="üå± V√°≈° Terapeutick√Ω Asistent" data-subtitle="Bezpeƒçn√Ω priestor pre va≈°e my≈°lienky">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H5.2L4,17.2V4H20V16M6,9H18V11H6V9M6,12H15V14H6V12M6,6H18V8H6V6Z" /></svg>
                <span>Chat</span>
            </button>
            <button class="nav-btn" data-view="toolsView" data-title="üßò N√°stroje pre pokoj" data-subtitle="Cviƒçenia pre va≈°u myseƒæ a telo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.5,4A1.5,1.5 0 0,1 16,5.5A1.5,1.5 0 0,1 14.5,7A1.5,1.5 0 0,1 13,5.5A1.5,1.5 0 0,1 14.5,4M22,13.5C22,12.44 20.89,11.05 19.2,11.05C18.66,11.05 18.23,11.19 17.91,11.41C17.06,10 15.63,8.95 13.5,8.95C10.5,8.95 8,11.5 8,14.5V20H10V14.5C10,12.61 11.61,11.05 13.5,11.05C15.11,11.05 16.44,12.18 16.89,13.62C16.5,14.2 16.2,14.88 16.2,15.65C16.2,17.75 18.13,18.95 20,18.95C21.97,18.95 22,16.5 22,16.5H20C20,16.5 19.88,17.05 18.7,17.05C17.88,17.05 17.9,16.2 17.9,15.65C17.9,14.7 18.5,13.5 20,13.5H22M6,13.5C6,12.44 4.89,11.05 3.2,11.05C2.66,11.05 2.23,11.19 1.91,11.41C1.06,10 0,8.95 0,8.95C0,8.95 2.5,11.5 2,14.5V20H4V14.5C4,12.61 5.61,11.05 7.5,11.05C9.11,11.05 10.44,12.18 10.89,13.62C10.5,14.2 10.2,14.88 10.2,15.65C10.2,17.75 12.13,18.95 14,18.95C15.97,18.95 16,16.5 16,16.5H14C14,16.5 13.88,17.05 12.7,17.05C11.88,17.05 11.9,16.2 11.9,15.65C11.9,14.7 12.5,13.5 14,13.5H16C16,13.5 16,12.44 14.89,11.05C13.2,11.05 12.23,11.19 11.91,11.41C11.06,10 9.63,8.95 7.5,8.95C4.5,8.95 6,11.5 6,13.5Z" /></svg>
                <span>N√°stroje</span>
            </button>
            <button class="nav-btn" data-view="dashboardView" data-title="üìä Stress Dashboard" data-subtitle="Va≈°e trendy a wellbeing analytics">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V17H10V19H12V16H16V19H18V17H22V21M16,8H18V15H16V8M12,2H14V15H12V2M8,9H10V15H8V9M4,11H6V15H4V11Z" /></svg>
                <span>Dashboard</span>
            </button>
        </nav>
    </div>

    <!-- Stress Tracking Overlay -->
    <div class="stress-overlay" id="stressOverlay">
        <div class="stress-container">
            <div class="stress-header">
                <h2>üìä Denn√© hodnotenie stresu</h2>
                <p>Ako ste sa dnes c√≠tili v pr√°ci? Va≈°e odpovede s√∫ anonymn√© a pom√¥≈æu zlep≈°i≈• pracovn√© prostredie.</p>
            </div>

            <form class="stress-form" id="stressForm">
                <div class="stress-question">
                    <label>1. Ak√° bola va≈°a celkov√° √∫rove≈à stresu dnes v pr√°ci?</label>
                    <div class="stress-scale-labels">
                        <span>≈Ωiadny stress</span>
                        <span>Extr√©mny stress</span>
                    </div>
                    <div class="stress-scale" id="stressScale">
                        <div class="stress-number" data-value="1">1</div>
                        <div class="stress-number" data-value="2">2</div>
                        <div class="stress-number" data-value="3">3</div>
                        <div class="stress-number" data-value="4">4</div>
                        <div class="stress-number" data-value="5">5</div>
                        <div class="stress-number" data-value="6">6</div>
                        <div class="stress-number" data-value="7">7</div>
                        <div class="stress-number" data-value="8">8</div>
                        <div class="stress-number" data-value="9">9</div>
                        <div class="stress-number" data-value="10">10</div>
                    </div>
                </div>

                <div class="stress-question">
                    <label>2. Ak√° bola va≈°a produktivita dnes? (voliteƒæn√©)</label>
                    <div class="stress-scale-labels">
                        <span>Veƒæmi n√≠zka</span>
                        <span>Veƒæmi vysok√°</span>
                    </div>
                    <div class="stress-scale" id="productivityScale">
                        <div class="stress-number" data-value="1">1</div>
                        <div class="stress-number" data-value="2">2</div>
                        <div class="stress-number" data-value="3">3</div>
                        <div class="stress-number" data-value="4">4</div>
                        <div class="stress-number" data-value="5">5</div>
                        <div class="stress-number" data-value="6">6</div>
                        <div class="stress-number" data-value="7">7</div>
                        <div class="stress-number" data-value="8">8</div>
                        <div class="stress-number" data-value="9">9</div>
                        <div class="stress-number" data-value="10">10</div>
                    </div>
                </div>

                <div class="stress-question">
                    <label>3. ƒåo v√°m dnes sp√¥sobilo najviac stresu? (voliteƒæn√©)</label>
                    <textarea class="stress-textarea" id="stressSource" placeholder="Napr√≠klad: Pr√≠li≈° veƒæa √∫loh, nevyhnutn√© deadlines, konflikty v t√≠me, technick√© probl√©my..."></textarea>
                </div>

                <div class="stress-question">
                    <label>4. ƒåo by v√°m pomohlo zn√≠≈æi≈• stress? (voliteƒæn√©)</label>
                    <textarea class="stress-textarea" id="stressHelp" placeholder="Napr√≠klad: Viac ƒçasu na √∫lohy, lep≈°ia komunik√°cia, pauzy, podpora od managementu..."></textarea>
                </div>

                <div class="stress-actions">
                    <button type="button" class="stress-btn secondary" onclick="closeStressTracking()">Zru≈°i≈•</button>
                    <button type="submit" class="stress-btn primary">Ulo≈æi≈• z√°znam</button>
                </div>
            </form>
        </div>
    </div>
    <div class="breathing-overlay" id="breathingOverlay">
        <div class="breathing-container">
            <div class="breathing-technique-selector">
                <div class="technique-buttons">
                    <button class="technique-btn active" data-technique="478">4-7-8 D√Ωchanie</button>
                    <button class="technique-btn" data-technique="box">Box D√Ωchanie</button>
                    <button class="technique-btn" data-technique="simple">Hlbok√© D√Ωchanie</button>
                </div>
            </div>

            <div class="breathing-circle">
                <div class="breathing-inner-circle" id="breathingCircle"></div>
            </div>

            <div class="breathing-instructions" id="breathingInstructions">
                Pripravte sa na zaƒçiatok cviƒçenia...
            </div>

            <div class="breathing-counter" id="breathingCounter">3</div>

            <div class="breathing-progress">
                <div class="breathing-progress-text" id="breathingProgressText">
                    Cyklus 1 z 5
                </div>
                <div class="breathing-progress-bar">
                    <div class="breathing-progress-fill" id="breathingProgressFill"></div>
                </div>
            </div>

            <div class="breathing-controls">
                <button class="breathing-btn" id="startBreathingBtn" onclick="startBreathingCycle()">Zaƒça≈•</button>
                <button class="breathing-btn" id="pauseBreathingBtn" onclick="pauseBreathing()" style="display: none;">Pauza</button>
                <button class="breathing-btn" onclick="closeBreathingExercise()">Ukonƒçi≈•</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://asisterapie-bcbqhaawdqduavgq.westeurope-01.azurewebsites.net';
        const CHECK_CONNECTION_INTERVAL = 30000;
        let isConnected = false;
        let connectionCheckInterval;
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusIndicator = document.getElementById('statusIndicator');
        const botAvatarSVG = `<svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,1,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>`;
        const userAvatarSVG = `<svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12A10,10,0,0,0,12,22A10,10,0,0,0,22,12A10,10,0,0,0,12,2ZM12,6a3,3,0,1,1-3,3A3,3,0,0,1,12,6Zm0,14a7,7,0,0,1-7-7c0-2.39,1.95-4.36,4.36-4.36h5.28C17.05,8.64,19,10.61,19,13A7,7,0,0,1,12,20Z"/></svg>`;
        
        // Stress Tracking Variables
        let stressData = [];
        let selectedStressLevel = null;
        let selectedProductivityLevel = null;

        // Load stress data from localStorage
        function loadStressData() {
            try {
                const saved = localStorage.getItem('stressTrackingData');
                if (saved) {
                    stressData = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading stress data:', error);
                stressData = [];
            }
        }

        // Save stress data to localStorage
        function saveStressData() {
            try {
                localStorage.setItem('stressTrackingData', JSON.stringify(stressData));
            } catch (error) {
                console.error('Error saving stress data:', error);
            }
        }

        // Stress Tracking Functions
        function startStressTracking() {
            document.getElementById('stressOverlay').style.display = 'flex';
            resetStressForm();
        }

        function closeStressTracking() {
            document.getElementById('stressOverlay').style.display = 'none';
            resetStressForm();
        }

        function resetStressForm() {
            selectedStressLevel = null;
            selectedProductivityLevel = null;
            
            // Reset all scale selections
            document.querySelectorAll('.stress-number').forEach(num => {
                num.classList.remove('selected');
            });
            
            // Clear textareas
            document.getElementById('stressSource').value = '';
            document.getElementById('stressHelp').value = '';
        }

        // Handle scale selections
        function setupStressScales() {
            // Stress level scale
            document.getElementById('stressScale').addEventListener('click', function(e) {
                if (e.target.classList.contains('stress-number')) {
                    // Remove previous selection in this scale
                    this.querySelectorAll('.stress-number').forEach(num => {
                        num.classList.remove('selected');
                    });
                    
                    // Add selection to clicked number
                    e.target.classList.add('selected');
                    selectedStressLevel = parseInt(e.target.dataset.value);
                }
            });

            // Productivity scale
            document.getElementById('productivityScale').addEventListener('click', function(e) {
                if (e.target.classList.contains('stress-number')) {
                    // Remove previous selection in this scale
                    this.querySelectorAll('.stress-number').forEach(num => {
                        num.classList.remove('selected');
                    });
                    
                    // Add selection to clicked number
                    e.target.classList.add('selected');
                    selectedProductivityLevel = parseInt(e.target.dataset.value);
                }
            });
        }

        // Handle form submission
        function setupStressForm() {
            document.getElementById('stressForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (selectedStressLevel === null) {
                    alert('Pros√≠m, vyberte √∫rove≈à stresu (1-10).');
                    return;
                }

                const stressEntry = {
                    date: new Date().toISOString(),
                    dateStr: new Date().toLocaleDateString('sk-SK'),
                    stressLevel: selectedStressLevel,
                    productivityLevel: selectedProductivityLevel,
                    stressSource: document.getElementById('stressSource').value.trim(),
                    stressHelp: document.getElementById('stressHelp').value.trim(),
                    timestamp: Date.now()
                };

                stressData.unshift(stressEntry); // Add to beginning
                saveStressData();
                updateDashboard();
                closeStressTracking();
                
                // Show success message
                setTimeout(() => {
                    alert('‚úÖ Stress z√°znam bol √∫spe≈°ne ulo≈æen√Ω! Pozrite si svoj dashboard pre trendy.');
                }, 300);
            });
        }

        // Update dashboard with current data
        function updateDashboard() {
            if (stressData.length === 0) {
                return;
            }

            // Calculate statistics
            const last7Days = stressData.filter(entry => {
                const entryDate = new Date(entry.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return entryDate >= weekAgo;
            });

            const avgStress = last7Days.length > 0 
                ? (last7Days.reduce((sum, entry) => sum + entry.stressLevel, 0) / last7Days.length).toFixed(1)
                : '-';

            // Calculate streak (consecutive days with entries)
            let streak = 0;
            const today = new Date();
            for (let i = 0; i < 30; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toLocaleDateString('sk-SK');
                
                const hasEntry = stressData.some(entry => entry.dateStr === dateStr);
                if (hasEntry) {
                    streak++;
                } else {
                    break;
                }
            }

            // Calculate trend
            const thisWeek = last7Days.slice(0, 3); // Last 3 days
            const lastWeek = stressData.filter(entry => {
                const entryDate = new Date(entry.date);
                const twoWeeksAgo = new Date();
                twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return entryDate >= twoWeeksAgo && entryDate < weekAgo;
            }).slice(0, 3);

            let trendIndicator = '‚û°Ô∏è';
            if (thisWeek.length > 0 && lastWeek.length > 0) {
                const thisWeekAvg = thisWeek.reduce((sum, entry) => sum + entry.stressLevel, 0) / thisWeek.length;
                const lastWeekAvg = lastWeek.reduce((sum, entry) => sum + entry.stressLevel, 0) / lastWeek.length;
                
                if (thisWeekAvg < lastWeekAvg - 0.5) {
                    trendIndicator = 'üìâ'; // Improving
                } else if (thisWeekAvg > lastWeekAvg + 0.5) {
                    trendIndicator = 'üìà'; // Worsening
                }
            }

            // Update dashboard stats
            document.getElementById('avgStressLevel').textContent = avgStress;
            document.getElementById('totalEntries').textContent = stressData.length;
            document.getElementById('streakDays').textContent = streak;
            document.getElementById('trendIndicator').textContent = trendIndicator;

            // Update history list
            updateStressHistory();
            
            // Update chart placeholder with simple trend info
            updateChartPlaceholder();
        }

        function updateStressHistory() {
            const historyList = document.getElementById('stressHistoryList');
            const recentEntries = stressData.slice(0, 10); // Last 10 entries

            if (recentEntries.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Zatiaƒæ ≈æiadne z√°znamy. Zaƒçnite sledova≈• svoj stress!</div>';
                return;
            }

            historyList.innerHTML = recentEntries.map(entry => {
                let scoreClass = 'low';
                if (entry.stressLevel >= 7) scoreClass = 'high';
                else if (entry.stressLevel >= 4) scoreClass = 'medium';

                return `
                    <div class="history-item">
                        <div>
                            <div class="history-date">${entry.dateStr}</div>
                            ${entry.stressSource ? `<div style="font-size: 12px; color: #999; margin-top: 2px;">${entry.stressSource.substring(0, 50)}${entry.stressSource.length > 50 ? '...' : ''}</div>` : ''}
                        </div>
                        <div class="history-score ${scoreClass}">${entry.stressLevel}/10</div>
                    </div>
                `;
            }).join('');
        }

        function updateChartPlaceholder() {
            const chartPlaceholder = document.getElementById('stressChart');
            
            if (stressData.length < 3) {
                chartPlaceholder.textContent = `üìà Graf stress trendov sa zobraz√≠ po ${3 - stressData.length} ƒèal≈°√≠ch z√°znamoch`;
                return;
            }

            // Simple trend visualization
            const last30Days = stressData.slice(0, 30);
            const avgStress = (last30Days.reduce((sum, entry) => sum + entry.stressLevel, 0) / last30Days.length).toFixed(1);
            
            chartPlaceholder.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 48px; color: var(--primary-color-start); margin-bottom: 10px;">${avgStress}</div>
                    <div style="font-size: 16px; color: #666; margin-bottom: 20px;">Priemern√Ω stress (30 dn√≠)</div>
                    <div style="font-size: 14px; color: #999;">
                        ${last30Days.length} z√°znamov ‚Ä¢ 
                        Min: ${Math.min(...last30Days.map(e => e.stressLevel))} ‚Ä¢ 
                        Max: ${Math.max(...last30Days.map(e => e.stressLevel))}
                    </div>
                </div>
            `;
        }

        // Export stress data as CSV
        function exportStressData() {
            if (stressData.length === 0) {
                alert('≈Ωiadne d√°ta na export. Zaƒçnite sledova≈• svoj stress!');
                return;
            }

            // Create CSV content
            const headers = ['D√°tum', 'Stress Level (1-10)', 'Produktivita (1-10)', 'Zdroj stresu', 'Pomoc pri strese'];
            const csvContent = [
                headers.join(','),
                ...stressData.map(entry => [
                    `"${entry.dateStr}"`,
                    entry.stressLevel,
                    entry.productivityLevel || '',
                    `"${entry.stressSource.replace(/"/g, '""')}"`,
                    `"${entry.stressHelp.replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `stress_tracking_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('üìä Stress d√°ta boli exportovan√© ako CSV s√∫bor!');
        }
        let breathingInterval;
        let breathingCurrentCycle = 0;
        let breathingTotalCycles = 5;
        let breathingTechnique = '478';
        let breathingPhase = 'ready'; // ready, inhale, hold, exhale
        let breathingPhaseTime = 0;
        let breathingIsRunning = false;
        let breathingIsPaused = false;

        // Breathing techniques configuration
        const breathingTechniques = {
            '478': {
                name: '4-7-8 D√Ωchanie',
                phases: [
                    { name: 'inhale', duration: 4, instruction: 'Vd√Ωchnite nosom' },
                    { name: 'hold', duration: 7, instruction: 'Zadr≈æte dych' },
                    { name: 'exhale', duration: 8, instruction: 'Vyd√Ωchnite √∫stami' }
                ]
            },
            'box': {
                name: 'Box D√Ωchanie',
                phases: [
                    { name: 'inhale', duration: 4, instruction: 'Vd√Ωchnite' },
                    { name: 'hold', duration: 4, instruction: 'Zadr≈æte dych' },
                    { name: 'exhale', duration: 4, instruction: 'Vyd√Ωchnite' },
                    { name: 'hold', duration: 4, instruction: 'Zadr≈æte dych' }
                ]
            },
            'simple': {
                name: 'Hlbok√© D√Ωchanie',
                phases: [
                    { name: 'inhale', duration: 6, instruction: 'Hlboko sa nad√Ωchnite' },
                    { name: 'exhale', duration: 6, instruction: 'Pomaly vyd√Ωchnite' }
                ]
            }
        };

        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`, { method: 'GET', credentials: 'include' });
                if (response.ok) {
                    isConnected = true;
                    statusIndicator.textContent = 'Pripojen√©';
                    statusIndicator.className = 'status-indicator connected';
                    messageInput.disabled = false; sendButton.disabled = false;
                    messageInput.placeholder = 'Nap√≠≈°te svoju spr√°vu...';
                } else { throw new Error(`Server responded with status: ${response.status}`); }
            } catch (error) {
                isConnected = false;
                statusIndicator.textContent = 'Odpojen√©'; statusIndicator.className = 'status-indicator disconnected';
                messageInput.disabled = true; sendButton.disabled = true;
                messageInput.placeholder = 'Server nie je dostupn√Ω...';
            }
        }

        async function sendMessage(event) {
            event.preventDefault();
            const message = messageInput.value.trim();
            if (!message || messageInput.disabled) return;
            if (!isConnected) { showError('Nie je mo≈æn√© pripoji≈• sa k serveru. Sk√∫≈°ame znova...'); checkConnection(); return; }
            
            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true; messageInput.disabled = true;
            showTypingIndicator();

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    credentials: 'include', 
                    body: JSON.stringify({ message: message }) 
                });
                const data = await response.json();

                hideTypingIndicator();

                if (response.ok) {
                    if (data.response_sequence && data.response_sequence.length > 0) {
                        for (let i = 0; i < data.response_sequence.length; i++) {
                            const msg = data.response_sequence[i];
                            await new Promise(resolve => setTimeout(resolve, i === 0 ? 100 : 800));
                            addMessage(msg.content, 'bot', msg.type);
                        }
                    } else {
                        showError('Server vr√°til pr√°zdnu odpoveƒè.');
                    }
                } else { 
                    throw new Error(data.error || 'Nepodarilo sa z√≠ska≈• odpoveƒè zo servera'); 
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Chyba siete. Skontrolujte pripojenie a sk√∫ste to znova.');
                await checkConnection();
            } finally {
                hideTypingIndicator();
                if (isConnected) { 
                    sendButton.disabled = false; 
                    messageInput.disabled = false; 
                    messageInput.focus(); 
                }
            }
        }

        function addMessage(content, sender, type = 'standard') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'user' ? userAvatarSVG : botAvatarSVG;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            if (sender === 'user') { 
                messageDiv.style.flexDirection = 'row-reverse'; 
            }
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function showError(message) {
            const existingError = chatMessages.querySelector('.error-message');
            if (existingError) existingError.remove();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `‚ùå ${message}`;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
            setTimeout(() => { if (errorDiv.parentNode) { errorDiv.remove(); } }, 5000);
        }

        async function startNewSession() {
            if (!isConnected) { showError('Nie je mo≈æn√© pripoji≈• sa k serveru.'); checkConnection(); return; }
            try {
                const response = await fetch(`${API_BASE_URL}/new-session`, { method: 'POST', credentials: 'include' });
                if (response.ok) {
                    const welcomeMessage = chatMessages.querySelector('.welcome-message');
                    const firstBotMessage = chatMessages.querySelector('.message.bot:first-of-type');
                    chatMessages.innerHTML = '';
                    if (welcomeMessage) chatMessages.appendChild(welcomeMessage);
                    if (firstBotMessage) { chatMessages.appendChild(firstBotMessage.cloneNode(true)); }
                    addMessage('Nov√° konverz√°cia bola spusten√°. Som pripraven√Ω poƒç√∫va≈•.', 'bot');
                } else { 
                    const data = await response.json(); 
                    throw new Error(data.error || 'Nepodarilo sa zaƒça≈• nov√∫ konverz√°ciu'); 
                }
            } catch (error) { 
                console.error('Error starting new session:', error); 
                showError('Nepodarilo sa zaƒça≈• nov√∫ konverz√°ciu. Sk√∫ste to znova.'); 
            }
        }

        // Breathing Exercise Functions
        function startBreathingExercise() {
            document.getElementById('breathingOverlay').style.display = 'flex';
            resetBreathingExercise();
        }

        function closeBreathingExercise() {
            document.getElementById('breathingOverlay').style.display = 'none';
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
            }
            resetBreathingExercise();
        }

        function resetBreathingExercise() {
            breathingCurrentCycle = 0;
            breathingPhase = 'ready';
            breathingPhaseTime = 0;
            breathingIsRunning = false;
            breathingIsPaused = false;
            
            document.getElementById('breathingCircle').className = 'breathing-inner-circle';
            document.getElementById('breathingInstructions').textContent = 'Pripravte sa na zaƒçiatok cviƒçenia...';
            document.getElementById('breathingCounter').textContent = '3';
            document.getElementById('breathingProgressText').textContent = 'Cyklus 1 z 5';
            document.getElementById('breathingProgressFill').style.width = '0%';
            document.getElementById('startBreathingBtn').style.display = 'inline-block';
            document.getElementById('pauseBreathingBtn').style.display = 'none';
        }

        function startBreathingCycle() {
            if (breathingIsRunning && !breathingIsPaused) return;
            
            breathingIsRunning = true;
            breathingIsPaused = false;
            breathingCurrentCycle = 0;
            breathingPhase = 'countdown';
            breathingPhaseTime = 3;
            
            document.getElementById('startBreathingBtn').style.display = 'none';
            document.getElementById('pauseBreathingBtn').style.display = 'inline-block';
            
            startCountdown();
        }

        function startCountdown() {
            document.getElementById('breathingInstructions').textContent = 'Pripravte sa...';
            
            const countdownInterval = setInterval(() => {
                document.getElementById('breathingCounter').textContent = breathingPhaseTime;
                breathingPhaseTime--;
                
                if (breathingPhaseTime < 0) {
                    clearInterval(countdownInterval);
                    startBreathingPhases();
                }
            }, 1000);
        }

        function startBreathingPhases() {
            breathingCurrentCycle = 1;
            breathingPhase = 'inhale';
            breathingPhaseTime = breathingTechniques[breathingTechnique].phases[0].duration;
            let currentPhaseIndex = 0;
            
            updateBreathingDisplay();
            
            breathingInterval = setInterval(() => {
                breathingPhaseTime--;
                document.getElementById('breathingCounter').textContent = breathingPhaseTime;
                
                if (breathingPhaseTime <= 0) {
                    // Move to next phase
                    currentPhaseIndex++;
                    
                    if (currentPhaseIndex >= breathingTechniques[breathingTechnique].phases.length) {
                        // Cycle complete
                        breathingCurrentCycle++;
                        currentPhaseIndex = 0;
                        
                        if (breathingCurrentCycle > breathingTotalCycles) {
                            // Exercise complete
                            completeBreathingExercise();
                            return;
                        }
                    }
                    
                    const currentPhase = breathingTechniques[breathingTechnique].phases[currentPhaseIndex];
                    breathingPhase = currentPhase.name;
                    breathingPhaseTime = currentPhase.duration;
                    updateBreathingDisplay();
                }
            }, 1000);
        }

        function updateBreathingDisplay() {
            const currentPhase = breathingTechniques[breathingTechnique].phases.find(p => p.name === breathingPhase);
            if (currentPhase) {
                document.getElementById('breathingInstructions').textContent = currentPhase.instruction;
            }
            
            // Update circle animation
            const circle = document.getElementById('breathingCircle');
            circle.className = `breathing-inner-circle ${breathingPhase}`;
            
            // Update progress
            const progress = ((breathingCurrentCycle - 1) / breathingTotalCycles) * 100;
            document.getElementById('breathingProgressFill').style.width = `${progress}%`;
            document.getElementById('breathingProgressText').textContent = `Cyklus ${breathingCurrentCycle} z ${breathingTotalCycles}`;
        }

        function pauseBreathing() {
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
                breathingIsPaused = true;
                document.getElementById('pauseBreathingBtn').textContent = 'Pokraƒçova≈•';
                document.getElementById('breathingInstructions').textContent = 'Cviƒçenie pozastaven√©';
            } else if (breathingIsPaused) {
                startBreathingPhases();
                breathingIsPaused = false;
                document.getElementById('pauseBreathingBtn').textContent = 'Pauza';
            }
        }

        function completeBreathingExercise() {
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
            }
            
            document.getElementById('breathingInstructions').textContent = 'Cviƒçenie dokonƒçen√©! V√Ωborne!';
            document.getElementById('breathingCounter').textContent = '‚úì';
            document.getElementById('breathingProgressFill').style.width = '100%';
            document.getElementById('breathingProgressText').textContent = 'Dokonƒçen√©';
            document.getElementById('pauseBreathingBtn').style.display = 'none';
            document.getElementById('startBreathingBtn').style.display = 'inline-block';
            document.getElementById('startBreathingBtn').textContent = 'Znova';
            
            setTimeout(() => {
                closeBreathingExercise();
            }, 3000);
        }

        function showTypingIndicator() { typingIndicator.style.display = 'flex'; scrollToBottom(); }
        function hideTypingIndicator() { typingIndicator.style.display = 'none'; }
        function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }

        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            setTimeout(() => messageInput.focus(), 100);
            connectionCheckInterval = setInterval(checkConnection, CHECK_CONNECTION_INTERVAL);
            messageInput.addEventListener('keypress', function(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendButton.click(); }});

            // Initialize stress tracking
            loadStressData();
            setupStressScales();
            setupStressForm();
            updateDashboard();

            const navButtons = document.querySelectorAll('.nav-btn');
            const views = document.querySelectorAll('.view');
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const newSessionBtn = document.querySelector('.new-session-btn');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const viewId = button.dataset.view;
                    const title = button.dataset.title;
                    const subtitle = button.dataset.subtitle;
                    views.forEach(view => {
                        view.classList.remove('active');
                        if (view.id === viewId) {
                            view.classList.add('active');
                        }
                    });
                    headerTitle.innerHTML = title;
                    headerSubtitle.textContent = subtitle;
                    newSessionBtn.style.display = (viewId === 'chatView') ? 'flex' : 'none';
                    
                    // Update dashboard when switching to it
                    if (viewId === 'dashboardView') {
                        updateDashboard();
                    }
                });
            });

            // Breathing technique selector
            const techniqueButtons = document.querySelectorAll('.technique-btn');
            techniqueButtons.forEach(button => {
                button.addEventListener('click', () => {
                    techniqueButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    breathingTechnique = button.dataset.technique;
                    resetBreathingExercise();
                });
            });
        });
        
        window.addEventListener('focus', () => { if (!messageInput.disabled) messageInput.focus(); });
        window.addEventListener('beforeunload', () => { if (connectionCheckInterval) clearInterval(connectionCheckInterval); });

    </script>
</body>
</html>
