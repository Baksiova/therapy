<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terapeutick√Ω Asistent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color-start: #6D5BBA;
            --primary-color-end: #8D58BF;
            --secondary-bg: #f5f7fa;
            --body-bg-start: #e0eafc;
            --body-bg-end: #cfdef3;
            --text-color-light: #ffffff;
            --text-color-dark: #333333;
            --border-color: #e0e0e0;
            --font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 20px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--body-bg-start) 0%, var(--body-bg-end) 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            background: var(--text-color-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light);
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }

        .chat-header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-header .chat-subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
        }

        .new-session-btn {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color-light); padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-size: 12px; font-family: var(--font-family);
            transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;
        }
        .new-session-btn:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-52%); }

        .status-indicator {
            position: absolute; top: 15px; left: 20px; padding: 4px 10px;
            border-radius: 12px; font-size: 11px; font-weight: 500;
            background: rgba(0, 0, 0, 0.2); color: var(--text-color-light); transition: all 0.3s ease;
        }
        .status-indicator.connected { background: #2ecc71; }
        .status-indicator.disconnected { background: #e74c3c; }
        .status-indicator.connecting { background: #f1c40f; }

        .app-main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; 
            flex-direction: column;
            background: var(--secondary-bg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .view.active {
            opacity: 1;
            visibility: visible;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 20px; display: flex; align-items: flex-end;
            gap: 10px; animation: slideIn 0.4s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .message-content {
            max-width: 75%; padding: 12px 18px; border-radius: var(--border-radius);
            word-wrap: break-word; line-height: 1.5; font-weight: 400;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light); border-bottom-right-radius: 5px;
        }
        .message.bot .message-content {
            background: var(--text-color-light); color: var(--text-color-dark); border-bottom-left-radius: 5px;
            white-space: pre-wrap; /* Toto zabezpeƒç√≠, ≈æe sa zalomia riadky pre kr√≠zov√© zdroje */
        }
        .message-avatar {
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); background: #fff;
        }
        .message-avatar svg { width: 20px; height: 20px; fill: var(--primary-color-start); }
        .message.user .message-avatar { order: 1; }
        
        .chat-input-container {
            padding: 15px 20px; background: var(--text-color-light);
            border-top: 1px solid var(--border-color);
        }
        .chat-input-form { display: flex; gap: 10px; align-items: center; }
        .chat-input {
            flex: 1; padding: 14px 20px; border: 1px solid var(--border-color);
            border-radius: 30px; font-size: 16px; font-family: var(--font-family);
            outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .chat-input:focus { border-color: var(--primary-color-start); box-shadow: 0 0 0 3px rgba(109, 91, 186, 0.15); }
        .chat-input:disabled { background: #f5f5f5; cursor: not-allowed; }
        
        .send-button {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light); border: none; width: 50px; height: 50px;
            border-radius: 50%; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .send-button svg { width: 24px; height: 24px; }
        .send-button:hover:not(:disabled) { transform: scale(1.1); }
        .send-button:disabled { opacity: 0.6; cursor: not-allowed; transform: scale(1); }

        .typing-indicator { display: none; align-items: center; margin: 0 20px 20px; gap: 10px; }
        .typing-dots { background: var(--text-color-light); border-radius: 18px; padding: 14px 18px; display: flex; gap: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .error-message { background: #fff0f0; color: #c0392b; padding: 12px; border-radius: 10px; margin: 0 20px 15px; border-left: 4px solid #e74c3c; animation: slideIn 0.3s ease-out; font-size: 14px; }
        .welcome-message { text-align: center; color: #777; padding: 15px; font-size: 14px; }

        #toolsView {
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            align-content: start;
        }
        .tool-card {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(109, 91, 186, 0.15);
        }
        .tool-card-icon {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .tool-card-icon svg { fill: var(--text-color-light); width: 28px; height: 28px; }
        .tool-card-content h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--text-color-dark); }
        .tool-card-content p { font-size: 14px; color: #666; }

        .app-nav {
            display: flex;
            background: #fff;
            border-top: 1px solid var(--border-color);
            padding: 8px 0;
            flex-shrink: 0;
        }
        .nav-btn {
            flex: 1; background: none; border: none;
            color: #999;
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; cursor: pointer;
            transition: color 0.3s ease;
            font-family: var(--font-family);
        }
        .nav-btn.active, .nav-btn:hover {
            color: var(--primary-color-start);
        }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .nav-btn span { font-size: 11px; font-weight: 500; }

        @media (max-width: 768px) {
            body { padding: 0; }
            .app-container { width: 100%; height: 100vh; border-radius: 0; }
            .chat-header h1 { font-size: 20px; }
            .new-session-btn { padding: 6px 10px; font-size: 11px; }
            .new-session-btn span { display: none; }
            #toolsView { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="chat-header">
            <div class="status-indicator connecting" id="statusIndicator">Connecting...</div>
            <h1 id="headerTitle">üå± V√°≈° Terapeutick√Ω Asistent</h1>
            <p id="headerSubtitle" class="chat-subtitle">Bezpeƒçn√Ω priestor pre va≈°e my≈°lienky</p>
            <button class="new-session-btn" onclick="startNewSession()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                <span id="newSessionText">New Session</span>
            </button>
        </div>

        <main class="app-main-content">
            <div id="chatView" class="view active">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">Vitajte. V≈°etko, ƒço tu zdieƒæate, je d√¥vern√©.</div>
                    <div class="message bot">
                        <div class="message-avatar">
                            <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,1,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>
                        </div>
                        <div class="message-content">Dobr√Ω de≈à! Som tu, aby som v√°s poƒç√∫val a podporil. Ako sa dnes c√≠tite?</div>
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">
                        <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>
                    </div>
                    <div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                </div>
                <div class="chat-input-container">
                    <form class="chat-input-form" onsubmit="sendMessage(event)">
                        <input type="text" class="chat-input" id="messageInput" placeholder="Nap√≠≈°te svoju spr√°vu..." maxlength="500" autocomplete="off" disabled>
                        <button type="submit" class="send-button" id="sendButton" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div id="toolsView" class="view">
                <div class="tool-card" onclick="alert('Sp√∫≈°≈•am dychov√© cviƒçenie...')">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.2,19H12.8C13.9,19 14.8,18.1 14.8,17V15H9.2V17C9.2,18.1 10.1,19 11.2,19H11.8V19.5C11.8,19.8 12,20 12.3,20S12.8,19.8 12.8,19.5V19M19.7,9.8C19.4,9.5 19,9.3 18.5,9.3H15.3V6.8C15.3,6.3 14.8,5.9 14.3,5.9S13.3,6.3 13.3,6.8V9.3H10.8V4.8C10.8,4.3 10.3,3.9 9.8,3.9S8.8,4.3 8.8,4.8V9.3H5.5C5,9.3 4.6,9.5 4.3,9.8C4,10.1 3.9,10.6 4.1,11L8.1,14.3H15.9L19.9,11C20.1,10.6 20,10.1 19.7,9.8Z" /></svg></div>
                    <div class="tool-card-content"><h3>Hlbok√Ω n√°dych</h3><p>5-min√∫tov√© cviƒçenie na okam≈æit√© upokojenie.</p></div>
                </div>
                <div class="tool-card" onclick="alert('Sp√∫≈°≈•am cviƒçenie vƒèaƒçnosti...')">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 3H7C5.9 3 5 3.9 5 5V19C5 20.1 5.9 21 7 21H17C18.1 21 19 20.1 19 19V5C19 3.9 18.1 3 17 3M12 18.2L11.1 17.4C8.2 14.8 6 12.8 6 10.3C6 8.5 7.5 7 9.3 7C10.3 7 11.3 7.4 12 8.1C12.7 7.4 13.7 7 14.7 7C16.5 7 18 8.5 18 10.3C18 12.8 15.8 14.8 12.9 17.4L12 18.2Z" /></svg></div>
                    <div class="tool-card-content"><h3>Denn√≠k vƒèaƒçnosti</h3><p>Zap√≠≈°te si tri veci, za ktor√© ste vƒèaƒçn√≠.</p></div>
                </div>
                 <div class="tool-card" onclick="alert('Sp√∫≈°≈•am medit√°ciu...')">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21,12C21,16.97 16.97,21 12,21C7.03,21 3,16.97 3,12C3,7.03 7.03,3 12,3C12.54,3 13.07,3.05 13.58,3.14L12,7L10.42,3.14C10.93,3.05 11.46,3 12,3M12,19C15.87,19 19,15.87 19,12C19,8.13 15.87,5 12,5C8.13,5 5,8.13 5,12C5,15.87 8.13,19 12,19M8.5,12.5L12,6L15.5,12.5H8.5M15.5,14.5L12,18L8.5,14.5H15.5Z" /></svg></div>
                    <div class="tool-card-content"><h3>Skenovanie tela</h3><p>10-min√∫tov√° riaden√° medit√°cia na uvoƒænenie.</p></div>
                </div>
            </div>
        </main>

        <nav class="app-nav">
            <button class="nav-btn active" data-view="chatView" data-title="üå± V√°≈° Terapeutick√Ω Asistent" data-subtitle="Bezpeƒçn√Ω priestor pre va≈°e my≈°lienky">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H5.2L4,17.2V4H20V16M6,9H18V11H6V9M6,12H15V14H6V12M6,6H18V8H6V6Z" /></svg>
                <span>Chat</span>
            </button>
            <button class="nav-btn" data-view="toolsView" data-title="üßò N√°stroje pre pokoj" data-subtitle="Cviƒçenia pre va≈°u myseƒæ a telo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.5,4A1.5,1.5 0 0,1 16,5.5A1.5,1.5 0 0,1 14.5,7A1.5,1.5 0 0,1 13,5.5A1.5,1.5 0 0,1 14.5,4M22,13.5C22,12.44 20.89,11.05 19.2,11.05C18.66,11.05 18.23,11.19 17.91,11.41C17.06,10 15.63,8.95 13.5,8.95C10.5,8.95 8,11.5 8,14.5V20H10V14.5C10,12.61 11.61,11.05 13.5,11.05C15.11,11.05 16.44,12.18 16.89,13.62C16.5,14.2 16.2,14.88 16.2,15.65C16.2,17.75 18.13,18.95 20,18.95C21.97,18.95 22,16.5 22,16.5H20C20,16.5 19.88,17.05 18.7,17.05C17.88,17.05 17.9,16.2 17.9,15.65C17.9,14.7 18.5,13.5 20,13.5H22M6,13.5C6,12.44 4.89,11.05 3.2,11.05C2.66,11.05 2.23,11.19 1.91,11.41C1.06,10 0,8.95 0,8.95C0,8.95 2.5,11.5 2,14.5V20H4V14.5C4,12.61 5.61,11.05 7.5,11.05C9.11,11.05 10.44,12.18 10.89,13.62C10.5,14.2 10.2,14.88 10.2,15.65C10.2,17.75 12.13,18.95 14,18.95C15.97,18.95 16,16.5 16,16.5H14C14,16.5 13.88,17.05 12.7,17.05C11.88,17.05 11.9,16.2 11.9,15.65C11.9,14.7 12.5,13.5 14,13.5H16C16,13.5 16,12.44 14.89,11.05C13.2,11.05 12.23,11.19 11.91,11.41C11.06,10 9.63,8.95 7.5,8.95C4.5,8.95 6,11.5 6,13.5Z" /></svg>
                <span>N√°stroje</span>
            </button>
        </nav>
    </div>

    <script>
        const API_BASE_URL = 'https://asisterapie-bcbqhaawdqduavgq.westeurope-01.azurewebsites.net';
        const CHECK_CONNECTION_INTERVAL = 30000;
        let isConnected = false;
        let connectionCheckInterval;
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusIndicator = document.getElementById('statusIndicator');
        const botAvatarSVG = `<svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,1,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>`;
        const userAvatarSVG = `<svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12A10,10,0,0,0,12,22A10,10,0,0,0,22,12A10,10,0,0,0,12,2ZM12,6a3,3,0,1,1-3,3A3,3,0,0,1,12,6Zm0,14a7,7,0,0,1-7-7c0-2.39,1.95-4.36,4.36-4.36h5.28C17.05,8.64,19,10.61,19,13A7,7,0,0,1,12,20Z"/></svg>`;
        
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`, { method: 'GET', credentials: 'include' });
                if (response.ok) {
                    isConnected = true;
                    statusIndicator.textContent = 'Pripojen√©';
                    statusIndicator.className = 'status-indicator connected';
                    messageInput.disabled = false; sendButton.disabled = false;
                    messageInput.placeholder = 'Nap√≠≈°te svoju spr√°vu...';
                } else { throw new Error(`Server responded with status: ${response.status}`); }
            } catch (error) {
                isConnected = false;
                statusIndicator.textContent = 'Odpojen√©'; statusIndicator.className = 'status-indicator disconnected';
                messageInput.disabled = true; sendButton.disabled = true;
                messageInput.placeholder = 'Server nie je dostupn√Ω...';
            }
        }

        async function sendMessage(event) {
            event.preventDefault();
            const message = messageInput.value.trim();
            if (!message || messageInput.disabled) return;
            if (!isConnected) { showError('Nie je mo≈æn√© pripoji≈• sa k serveru. Sk√∫≈°ame znova...'); checkConnection(); return; }
            
            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true; messageInput.disabled = true;
            showTypingIndicator();

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    credentials: 'include', 
                    body: JSON.stringify({ message: message }) 
                });
                const data = await response.json();

                hideTypingIndicator(); // Skryjeme indik√°tor hneƒè po prijat√≠ odpovede

                if (response.ok) {
                    if (data.response_sequence && data.response_sequence.length > 0) {
                        for (let i = 0; i < data.response_sequence.length; i++) {
                            const msg = data.response_sequence[i];
                            // Prid√°me mal√© oneskorenie medzi spr√°vami pre prirodzenej≈°√≠ pocit
                            await new Promise(resolve => setTimeout(resolve, i === 0 ? 100 : 800));
                            addMessage(msg.content, 'bot', msg.type);
                        }
                    } else {
                        showError('Server vr√°til pr√°zdnu odpoveƒè.');
                    }
                } else { 
                    throw new Error(data.error || 'Nepodarilo sa z√≠ska≈• odpoveƒè zo servera'); 
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Chyba siete. Skontrolujte pripojenie a sk√∫ste to znova.');
                await checkConnection();
            } finally {
                hideTypingIndicator();
                if (isConnected) { 
                    sendButton.disabled = false; 
                    messageInput.disabled = false; 
                    messageInput.focus(); 
                }
            }
        }

        function addMessage(content, sender, type = 'standard') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = sender === 'user' ? userAvatarSVG : botAvatarSVG;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            // Text sa vlo≈æ√≠ bezpeƒçne, aby sa zabr√°nilo HTML injekcii
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            if (sender === 'user') { 
                messageDiv.style.flexDirection = 'row-reverse'; 
            }
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        function showError(message) {
            const existingError = chatMessages.querySelector('.error-message');
            if (existingError) existingError.remove();
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `‚ùå ${message}`;
            chatMessages.appendChild(errorDiv);
            scrollToBottom();
            setTimeout(() => { if (errorDiv.parentNode) { errorDiv.remove(); } }, 5000);
        }

        async function startNewSession() {
            if (!isConnected) { showError('Nie je mo≈æn√© pripoji≈• sa k serveru.'); checkConnection(); return; }
            try {
                const response = await fetch(`${API_BASE_URL}/new-session`, { method: 'POST', credentials: 'include' });
                if (response.ok) {
                    const welcomeMessage = chatMessages.querySelector('.welcome-message');
                    const firstBotMessage = chatMessages.querySelector('.message.bot:first-of-type');
                    chatMessages.innerHTML = '';
                    if (welcomeMessage) chatMessages.appendChild(welcomeMessage);
                    if (firstBotMessage) { chatMessages.appendChild(firstBotMessage.cloneNode(true)); }
                    addMessage('Nov√° konverz√°cia bola spusten√°. Som pripraven√Ω poƒç√∫va≈•.', 'bot');
                } else { 
                    const data = await response.json(); 
                    throw new Error(data.error || 'Nepodarilo sa zaƒça≈• nov√∫ konverz√°ciu'); 
                }
            } catch (error) { 
                console.error('Error starting new session:', error); 
                showError('Nepodarilo sa zaƒça≈• nov√∫ konverz√°ciu. Sk√∫ste to znova.'); 
            }
        }

        function showTypingIndicator() { typingIndicator.style.display = 'flex'; scrollToBottom(); }
        function hideTypingIndicator() { typingIndicator.style.display = 'none'; }
        function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }

        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            setTimeout(() => messageInput.focus(), 100);
            connectionCheckInterval = setInterval(checkConnection, CHECK_CONNECTION_INTERVAL);
            messageInput.addEventListener('keypress', function(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendButton.click(); }});

            const navButtons = document.querySelectorAll('.nav-btn');
            const views = document.querySelectorAll('.view');
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const newSessionBtn = document.querySelector('.new-session-btn');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const viewId = button.dataset.view;
                    const title = button.dataset.title;
                    const subtitle = button.dataset.subtitle;
                    views.forEach(view => {
                        view.classList.remove('active');
                        if (view.id === viewId) {
                            view.classList.add('active');
                        }
                    });
                    headerTitle.innerHTML = title;
                    headerSubtitle.textContent = subtitle;
                    newSessionBtn.style.display = (viewId === 'chatView') ? 'flex' : 'none';
                });
            });
        });
        
        window.addEventListener('focus', () => { if (!messageInput.disabled) messageInput.focus(); });
        window.addEventListener('beforeunload', () => { if (connectionCheckInterval) clearInterval(connectionCheckInterval); });

    </script>
</body>
</html>
