<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terapeutick√Ω Asistent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color-start: #6D5BBA;
            --primary-color-end: #8D58BF;
            --secondary-bg: #f5f7fa;
            --body-bg-start: #e0eafc;
            --body-bg-end: #cfdef3;
            --text-color-light: #ffffff;
            --text-color-dark: #333333;
            --border-color: #e0e0e0;
            --font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 20px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: linear-gradient(135deg, var(--body-bg-start) 0%, var(--body-bg-end) 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            background: var(--text-color-light);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light);
            padding: 20px;
            text-align: center;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }

        .chat-header h1 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-header .chat-subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
        }

        .new-session-btn {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color-light); padding: 8px 16px; border-radius: 20px;
            cursor: pointer; font-size: 12px; font-family: var(--font-family);
            transition: all 0.3s ease; display: flex; align-items: center; gap: 6px;
        }
        .new-session-btn:hover { background: rgba(255, 255, 255, 0.25); transform: translateY(-52%); }

        .status-indicator {
            position: absolute; top: 15px; left: 20px; padding: 4px 10px;
            border-radius: 12px; font-size: 11px; font-weight: 500;
            background: rgba(0, 0, 0, 0.2); color: var(--text-color-light); transition: all 0.3s ease;
        }
        .status-indicator.connected { background: #2ecc71; }
        .status-indicator.disconnected { background: #e74c3c; }
        .status-indicator.connecting { background: #f1c40f; }

        .app-main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .view {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; 
            flex-direction: column;
            background: var(--secondary-bg);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .view.active {
            opacity: 1;
            visibility: visible;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 20px; display: flex; align-items: flex-end;
            gap: 10px; animation: slideIn 0.4s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .message-content {
            max-width: 75%; padding: 12px 18px; border-radius: var(--border-radius);
            word-wrap: break-word; line-height: 1.5; font-weight: 400;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light); border-bottom-right-radius: 5px;
        }
        .message.bot .message-content {
            background: var(--text-color-light); color: var(--text-color-dark); border-bottom-left-radius: 5px;
            white-space: pre-wrap;
        }
        .message-avatar {
            width: 40px; height: 40px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08); background: #fff;
        }
        .message-avatar svg { width: 20px; height: 20px; fill: var(--primary-color-start); }
        .message.user .message-avatar { order: 1; }
        
        .chat-input-container {
            padding: 15px 20px; background: var(--text-color-light);
            border-top: 1px solid var(--border-color);
        }
        .chat-input-form { display: flex; gap: 10px; align-items: center; }
        .chat-input {
            flex: 1; padding: 14px 20px; border: 1px solid var(--border-color);
            border-radius: 30px; font-size: 16px; font-family: var(--font-family);
            outline: none; transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .chat-input:focus { border-color: var(--primary-color-start); box-shadow: 0 0 0 3px rgba(109, 91, 186, 0.15); }
        .chat-input:disabled { background: #f5f5f5; cursor: not-allowed; }
        
        .send-button {
            background: linear-gradient(135deg, var(--primary-color-start) 0%, var(--primary-color-end) 100%);
            color: var(--text-color-light); border: none; width: 50px; height: 50px;
            border-radius: 50%; cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .send-button svg { width: 24px; height: 24px; }
        .send-button:hover:not(:disabled) { transform: scale(1.1); }
        .send-button:disabled { opacity: 0.6; cursor: not-allowed; transform: scale(1); }

        .typing-indicator { display: none; align-items: center; margin: 0 20px 20px; gap: 10px; }
        .typing-dots { background: var(--text-color-light); border-radius: 18px; padding: 14px 18px; display: flex; gap: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; animation: typing 1.4s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .error-message { background: #fff0f0; color: #c0392b; padding: 12px; border-radius: 10px; margin: 0 20px 15px; border-left: 4px solid #e74c3c; animation: slideIn 0.3s ease-out; font-size: 14px; }
        .welcome-message { text-align: center; color: #777; padding: 15px; font-size: 14px; }

        #toolsView {
            padding: 20px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            align-content: start;
        }
        .tool-card {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border-color);
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(109, 91, 186, 0.15);
        }
        .tool-card-icon {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end));
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .tool-card-icon svg { fill: var(--text-color-light); width: 28px; height: 28px; }
        .tool-card-content h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--text-color-dark); }
        .tool-card-content p { font-size: 14px; color: #666; }

        .app-nav {
            display: flex;
            background: #fff;
            border-top: 1px solid var(--border-color);
            padding: 8px 0;
            flex-shrink: 0;
        }
        .nav-btn {
            flex: 1; background: none; border: none;
            color: #999;
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; cursor: pointer;
            transition: color 0.3s ease;
            font-family: var(--font-family);
        }
        .nav-btn.active, .nav-btn:hover {
            color: var(--primary-color-start);
        }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .nav-btn span { font-size: 11px; font-weight: 500; }

        /* Generic Overlay styles */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        .overlay-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .overlay-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .overlay-header h2 { color: var(--text-color-dark); font-size: 24px; margin-bottom: 10px; }
        .overlay-header p { color: #666; font-size: 14px; }
        .overlay-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .overlay-btn { padding: 12px 24px; border: none; border-radius: 25px; cursor: pointer; font-family: var(--font-family); font-size: 14px; font-weight: 500; transition: all 0.3s ease; }
        .overlay-btn.primary { background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end)); color: white; }
        .overlay-btn.primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(109, 91, 186, 0.3); }
        .overlay-btn.secondary { background: #f5f5f5; color: var(--text-color-dark); border: 1px solid var(--border-color); }
        .overlay-btn.secondary:hover { background: #e0e0e0; }

        /* Breathing Exercise Overlay */
        .breathing-container { text-align: center; color: white; max-width: 500px; padding: 40px; position: relative; }
        .breathing-circle { width: 300px; height: 300px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; margin: 0 auto 40px; position: relative; display: flex; align-items: center; justify-content: center; }
        .breathing-inner-circle { width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end)); border-radius: 50%; transition: transform 0.3s ease; box-shadow: 0 0 30px rgba(109, 91, 186, 0.5); }
        .breathing-inner-circle.inhale, .breathing-inner-circle.hold { transform: scale(3.5); }
        .breathing-inner-circle.exhale { transform: scale(1); }
        .breathing-instructions { font-size: 24px; font-weight: 600; margin-bottom: 20px; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .breathing-counter { font-size: 48px; font-weight: 300; margin-bottom: 20px; opacity: 0.8; }
        .breathing-progress { margin-bottom: 30px; }
        .breathing-progress-text { font-size: 16px; opacity: 0.7; margin-bottom: 10px; }
        .breathing-progress-bar { width: 100%; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; overflow: hidden; }
        .breathing-progress-fill { height: 100%; background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end)); width: 0%; transition: width 0.3s ease; }
        .breathing-controls { display: flex; gap: 20px; justify-content: center; margin-top: 30px; }
        .breathing-btn { padding: 12px 24px; border: 2px solid rgba(255, 255, 255, 0.3); background: transparent; color: white; border-radius: 25px; cursor: pointer; font-family: var(--font-family); font-size: 14px; transition: all 0.3s ease; }
        .breathing-btn:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.5); }
        .breathing-technique-selector { margin-bottom: 30px; }
        .technique-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .technique-btn { padding: 8px 16px; border: 1px solid rgba(255, 255, 255, 0.3); background: transparent; color: white; border-radius: 20px; cursor: pointer; font-family: var(--font-family); font-size: 12px; transition: all 0.3s ease; }
        .technique-btn.active { background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end)); border-color: transparent; }

        /* PSS Assessment Styles */
        #pssQuestionList { display: flex; flex-direction: column; gap: 25px; }
        .pss-question { background: #f9f9f9; padding: 15px; border-radius: 10px; border-left: 4px solid var(--primary-color-start); }
        .pss-question p { font-weight: 500; margin-bottom: 15px; color: var(--text-color-dark); }
        .pss-scale { display: flex; flex-direction: column; gap: 8px; }
        .pss-scale label { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 8px; transition: background-color 0.2s ease; }
        .pss-scale label:hover { background-color: #efedfb; }
        .pss-scale input[type="radio"] { accent-color: var(--primary-color-start); }
        #pssResultContainer { text-align: center; padding: 20px; }
        #pssResultScore { font-size: 48px; font-weight: 600; color: var(--primary-color-start); margin-bottom: 10px; }
        #pssResultInterpretation { font-size: 18px; color: #555; }
        
        /* Stress Tracking Overlay */
        .stress-form { display: flex; flex-direction: column; gap: 25px; }
        .stress-question { display: flex; flex-direction: column; gap: 15px; }
        .stress-question label { font-weight: 600; color: var(--text-color-dark); font-size: 16px; }
        .stress-scale { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin: 10px 0; }
        .stress-number { width: 40px; height: 40px; border: 2px solid var(--border-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 600; transition: all 0.3s ease; background: white; }
        .stress-number:hover { border-color: var(--primary-color-start); transform: scale(1.1); }
        .stress-number.selected { background: linear-gradient(135deg, var(--primary-color-start), var(--primary-color-end)); color: white; border-color: var(--primary-color-start); }
        .stress-textarea { width: 100%; padding: 15px; border: 1px solid var(--border-color); border-radius: 10px; font-family: var(--font-family); font-size: 14px; resize: vertical; min-height: 80px; outline: none; transition: border-color 0.3s ease; }
        .stress-textarea:focus { border-color: var(--primary-color-start); box-shadow: 0 0 0 3px rgba(109, 91, 186, 0.15); }
        
        /* Dashboard View */
        .dashboard-view { flex-direction: column; }
        #dashboardView { padding: 20px; overflow-y: auto; }
        .dashboard-header { text-align: center; margin-bottom: 30px; flex-shrink: 0; }
        .dashboard-header h2 { color: var(--text-color-dark); font-size: 24px; margin-bottom: 10px; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; flex-shrink: 0; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .stat-number { font-size: 32px; font-weight: 600; color: var(--primary-color-start); margin-bottom: 5px; }
        .stat-label { font-size: 14px; color: #666; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-shrink: 0; }
        .chart-title { font-size: 18px; font-weight: 600; color: var(--text-color-dark); margin-bottom: 15px; }
        .chart-placeholder { height: 200px; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px; }
        .stress-history { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-shrink: 0; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .history-item:last-child { border-bottom: none; }
        .history-date { font-size: 14px; color: #666; }
        .history-score { font-size: 16px; font-weight: 600; padding: 4px 12px; border-radius: 20px; color: white; }
        .history-score.low { background: #2ecc71; }
        .history-score.medium { background: #f39c12; }
        .history-score.high { background: #e74c3c; }

        @media (max-width: 768px) {
            .overlay-container, .breathing-container { padding: 20px; }
            .stress-scale { flex-wrap: wrap; gap: 8px; }
            .stress-number { width: 35px; height: 35px; font-size: 14px; }
            .dashboard-stats { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="chat-header">
            <div class="status-indicator connecting" id="statusIndicator">Connecting...</div>
            <h1 id="headerTitle">üå± V√°≈° Terapeutick√Ω Asistent</h1>
            <p id="headerSubtitle" class="chat-subtitle">Bezpeƒçn√Ω priestor pre va≈°e my≈°lienky</p>
            <button class="new-session-btn" onclick="startNewSession()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                <span id="newSessionText">New Session</span>
            </button>
        </div>

        <main class="app-main-content">
            <div id="chatView" class="view active">
                <div class="chat-messages" id="chatMessages">
                    <div class="welcome-message">Vitajte. V≈°etko, ƒço tu zdieƒæate, je d√¥vern√©.</div>
                    <div class="message bot">
                        <div class="message-avatar">
                            <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,1,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>
                        </div>
                        <div class="message-content">Dobr√Ω de≈à! Som tu, aby som v√°s poƒç√∫val a podporil. Ako sa dnes c√≠tite?</div>
                    </div>
                </div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar">
                        <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,1,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>
                    </div>
                    <div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                </div>
                <div class="chat-input-container">
                    <form class="chat-input-form" id="chatForm">
                        <input type="text" class="chat-input" id="messageInput" placeholder="Nap√≠≈°te svoju spr√°vu..." maxlength="500" autocomplete="off" disabled>
                        <button type="submit" class="send-button" id="sendButton" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div id="toolsView" class="view">
                 <div class="tool-card" onclick="startBreathingExercise()">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.2,19H12.8C13.9,19 14.8,18.1 14.8,17V15H9.2V17C9.2,18.1 10.1,19 11.2,19H11.8V19.5C11.8,19.8 12,20 12.3,20S12.8,19.8 12.8,19.5V19M19.7,9.8C19.4,9.5 19,9.3 18.5,9.3H15.3V6.8C15.3,6.3 14.8,5.9 14.3,5.9S13.3,6.3 13.3,6.8V9.3H10.8V4.8C10.8,4.3 10.3,3.9 9.8,3.9S8.8,4.3 8.8,4.8V9.3H5.5C5,9.3 4.6,9.5 4.3,9.8C4,10.1 3.9,10.6 4.1,11L8.1,14.3H15.9L19.9,11C20.1,10.6 20,10.1 19.7,9.8Z" /></svg></div>
                    <div class="tool-card-content"><h3>Hlbok√Ω n√°dych</h3><p>Cviƒçenie na okam≈æit√© upokojenie.</p></div>
                </div>
                <div class="tool-card" onclick="startStressTracking()">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M14.5,9A1.5,1.5 0 0,1 16,10.5A1.5,1.5 0 0,1 14.5,12A1.5,1.5 0 0,1 13,10.5A1.5,1.5 0 0,1 14.5,9M9.5,9A1.5,1.5 0 0,1 11,10.5A1.5,1.5 0 0,1 9.5,12A1.5,1.5 0 0,1 8,10.5A1.5,1.5 0 0,1 9.5,9M12,17.23C10.25,17.23 8.71,16.5 7.81,15.42L9.23,14C9.68,14.72 10.75,15.23 12,15.23C13.25,15.23 14.32,14.72 14.77,14L16.19,15.42C15.29,16.5 13.75,17.23 12,17.23Z" /></svg></div>
                    <div class="tool-card-content"><h3>Denn√Ω Stress Tracker</h3><p>R√Ωchle denn√© hodnotenie stresu a sp√°nku.</p></div>
                </div>
                <div class="tool-card" onclick="openPssAssessment()">
                    <div class="tool-card-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,3H5C3.89,3 3,3.89 3,5V19C3,20.11 3.9,21 5,21H19C20.11,21 21,20.11 21,19V5C21,3.89 20.11,3 19,3M19,5V19H5V5H19M17,17H7V15H17V17M17,13H7V11H17V13M17,9H7V7H17V9Z" /></svg></div>
                    <div class="tool-card-content"><h3>Mesaƒçn√© hodnotenie (PSS-10)</h3><p>Validovan√Ω dotazn√≠k na hƒ∫bkov√∫ anal√Ωzu stresu.</p></div>
                </div>
            </div>

            <div id="dashboardView" class="view dashboard-view">
                <div class="dashboard-header">
                    <h2>üìä V√°≈° Stress Dashboard</h2>
                    <p>Prehƒæad va≈°ich stress trendov a wellbeing metr√≠k</p>
                </div>
                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="avgStressLevel">-</div>
                        <div class="stat-label">Priem. stress (7d)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastPssScore">-</div>
                        <div class="stat-label">Posledn√© PSS sk√≥re</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalEntries">0</div>
                        <div class="stat-label">Celkom z√°znamov</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="streakDays">0</div>
                        <div class="stat-label">Dni v rade</div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Stress Level Trendy (Posledn√Ωch 30 dn√≠)</div>
                    <div class="chart-placeholder" id="stressChart">
                        üìà Graf stress trendov sa zobraz√≠ po prv√Ωch z√°znamoch
                    </div>
                </div>
                <div class="stress-history">
                    <h3 class="chart-title">Ned√°vne z√°znamy</h3>
                    <div id="stressHistoryList">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            Zatiaƒæ ≈æiadne z√°znamy. Zaƒçnite sledova≈• svoj stress!
                        </div>
                    </div>
                </div>
                <div class="overlay-actions" style="margin-top: 20px;">
                    <button class="overlay-btn primary" onclick="startStressTracking()">+ Nov√Ω denn√Ω z√°znam</button>
                    <button class="overlay-btn secondary" onclick="exportStressData()">üìä Export d√°t</button>
                </div>
            </div>
        </main>

        <nav class="app-nav">
            <button class="nav-btn active" data-view="chatView" data-title="üå± V√°≈° Terapeutick√Ω Asistent" data-subtitle="Bezpeƒçn√Ω priestor pre va≈°e my≈°lienky">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H5.2L4,17.2V4H20V16M6,9H18V11H6V9M6,12H15V14H6V12M6,6H18V8H6V6Z" /></svg>
                <span>Chat</span>
            </button>
            <button class="nav-btn" data-view="toolsView" data-title="üßò N√°stroje pre pokoj" data-subtitle="Cviƒçenia pre va≈°u myseƒæ a telo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.5,4A1.5,1.5 0 0,1 16,5.5A1.5,1.5 0 0,1 14.5,7A1.5,1.5 0 0,1 13,5.5A1.5,1.5 0 0,1 14.5,4M22,13.5C22,12.44 20.89,11.05 19.2,11.05C18.66,11.05 18.23,11.19 17.91,11.41C17.06,10 15.63,8.95 13.5,8.95C10.5,8.95 8,11.5 8,14.5V20H10V14.5C10,12.61 11.61,11.05 13.5,11.05C15.11,11.05 16.44,12.18 16.89,13.62C16.5,14.2 16.2,14.88 16.2,15.65C16.2,17.75 18.13,18.95 20,18.95C21.97,18.95 22,16.5 22,16.5H20C20,16.5 19.88,17.05 18.7,17.05C17.88,17.05 17.9,16.2 17.9,15.65C17.9,14.7 18.5,13.5 20,13.5H22M6,13.5C6,12.44 4.89,11.05 3.2,11.05C2.66,11.05 2.23,11.19 1.91,11.41C1.06,10 0,8.95 0,8.95C0,8.95 2.5,11.5 2,14.5V20H4V14.5C4,12.61 5.61,11.05 7.5,11.05C9.11,11.05 10.44,12.18 10.89,13.62C10.5,14.2 10.2,14.88 10.2,15.65C10.2,17.75 12.13,18.95 14,18.95C15.97,18.95 16,16.5 16,16.5H14C14,16.5 13.88,17.05 12.7,17.05C11.88,17.05 11.9,16.2 11.9,15.65C11.9,14.7 12.5,13.5 14,13.5H16C16,13.5 16,12.44 14.89,11.05C13.2,11.05 12.23,11.19 11.91,11.41C11.06,10 9.63,8.95 7.5,8.95C4.5,8.95 6,11.5 6,13.5Z" /></svg>
                <span>N√°stroje</span>
            </button>
            <button class="nav-btn" data-view="dashboardView" data-title="üìä Stress Dashboard" data-subtitle="Va≈°e trendy a wellbeing analytics">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22,21H2V3H4V19H6V17H10V19H12V16H16V19H18V17H22V21M16,8H18V15H16V8M12,2H14V15H12V2M8,9H10V15H8V9M4,11H6V15H4V11Z" /></svg>
                <span>Dashboard</span>
            </button>
        </nav>
    </div>

    <!-- Breathing Exercise Overlay -->
    <div class="overlay" id="breathingOverlay">
        <div class="breathing-container">
            <div class="breathing-technique-selector">
                <div class="technique-buttons">
                    <button class="technique-btn active" data-technique="478">4-7-8 D√Ωchanie</button>
                    <button class="technique-btn" data-technique="box">Box D√Ωchanie</button>
                    <button class="technique-btn" data-technique="simple">Hlbok√© D√Ωchanie</button>
                </div>
            </div>

            <div class="breathing-circle">
                <div class="breathing-inner-circle" id="breathingCircle"></div>
            </div>

            <div class="breathing-instructions" id="breathingInstructions">
                Pripravte sa na zaƒçiatok cviƒçenia...
            </div>

            <div class="breathing-counter" id="breathingCounter">3</div>

            <div class="breathing-progress">
                <div class="breathing-progress-text" id="breathingProgressText">
                    Cyklus 1 z 5
                </div>
                <div class="breathing-progress-bar">
                    <div class="breathing-progress-fill" id="breathingProgressFill"></div>
                </div>
            </div>

            <div class="breathing-controls">
                <button class="breathing-btn" id="startBreathingBtn" onclick="startBreathingCycle()">Zaƒça≈•</button>
                <button class="breathing-btn" id="pauseBreathingBtn" onclick="pauseBreathing()" style="display: none;">Pauza</button>
                <button class="breathing-btn" onclick="closeBreathingExercise()">Ukonƒçi≈•</button>
            </div>
        </div>
    </div>
    
    <!-- PSS Assessment Overlay -->
    <div class="overlay" id="pssOverlay">
        <div class="overlay-container">
            <div class="overlay-header">
                <h2>Mesaƒçn√© hodnotenie stresu (PSS-10)</h2>
                <p>Nasleduj√∫ce ot√°zky sa t√Ωkaj√∫ va≈°ich pocitov a my≈°lienok za <b>posledn√Ω mesiac</b>.</p>
            </div>
            <form id="pssForm">
                <div id="pssQuestionList">
                    <!-- Questions will be generated by JS -->
                </div>
                <div id="pssResultContainer" style="display: none;">
                    <p>Va≈°e celkov√© sk√≥re vn√≠man√©ho stresu je:</p>
                    <div id="pssResultScore"></div>
                    <p id="pssResultInterpretation"></p>
                    <div class="overlay-actions">
                        <button type="button" class="overlay-btn primary" onclick="closePssAssessment()">Zavrie≈•</button>
                    </div>
                </div>
                <div class="overlay-actions" id="pssFormActions">
                    <button type="button" class="overlay-btn secondary" onclick="closePssAssessment()">Zru≈°i≈•</button>
                    <button type="submit" class="overlay-btn primary">Ulo≈æi≈• a zobrazi≈• v√Ωsledok</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stress Tracking Overlay -->
    <div class="overlay" id="stressOverlay">
        <div class="overlay-container">
            <div class="overlay-header">
                <h2>üìä Denn√© hodnotenie</h2>
                <p>Ako ste sa dnes c√≠tili? Tieto r√Ωchle ot√°zky v√°m pom√¥≈æu sledova≈• denn√© trendy.</p>
            </div>

            <form class="stress-form" id="stressForm">
                <div class="stress-question">
                    <label>1. Ak√° bola va≈°a celkov√° √∫rove≈à stresu dnes v pr√°ci? (1 = ≈æiadny, 10 = extr√©mny)</label>
                    <div class="stress-scale" id="stressScale">
                         <!-- Numbers 1-10 generated by JS -->
                    </div>
                </div>
                <div class="stress-question">
                    <label>2. Ak√° bola kvalita v√°≈°ho sp√°nku minul√∫ noc? (1 = veƒæmi zl√°, 5 = vynikaj√∫ca)</label>
                    <div class="stress-scale" id="sleepScale">
                         <!-- Numbers 1-5 generated by JS -->
                    </div>
                </div>
                <div class="stress-question">
                    <label>3. Pozn√°mky pre seba (voliteƒæn√©)</label>
                    <textarea class="stress-textarea" id="stressSource" placeholder="ƒåo v√°m dnes sp√¥sobilo stres alebo naopak, pote≈°ilo v√°s?"></textarea>
                </div>

                <div class="overlay-actions">
                    <button type="button" class="overlay-btn secondary" onclick="closeStressTracking()">Zru≈°i≈•</button>
                    <button type="submit" class="overlay-btn primary">Ulo≈æi≈• z√°znam</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // --- Global Variables & Constants ---
        const API_BASE_URL = ''; // Pou≈æije relat√≠vnu cestu, keƒè≈æe FE a BE be≈æia na rovnakej dom√©ne
        const CHECK_CONNECTION_INTERVAL = 30000;
        let isConnected = false;
        let connectionCheckInterval;

        let stressData = [];
        let selectedStressLevel = null;
        let selectedSleepLevel = null;
        
        // --- Chat & Server Communication ---
        async function checkConnection() {
            const statusIndicator = document.getElementById('statusIndicator');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    isConnected = true;
                    statusIndicator.textContent = 'Pripojen√©';
                    statusIndicator.className = 'status-indicator connected';
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    messageInput.placeholder = 'Nap√≠≈°te svoju spr√°vu...';
                } else {
                    throw new Error('Server not healthy');
                }
            } catch (error) {
                isConnected = false;
                statusIndicator.textContent = 'Odpojen√©';
                statusIndicator.className = 'status-indicator disconnected';
                if(messageInput) {
                    messageInput.disabled = true;
                    sendButton.disabled = true;
                    messageInput.placeholder = 'Server nie je dostupn√Ω...';
                }
            }
        }

        async function sendMessage(event) {
            event.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message || messageInput.disabled) return;
            if (!isConnected) {
                showError('Nie je mo≈æn√© pripoji≈• sa k serveru. Sk√∫≈°ame znova...');
                checkConnection();
                return;
            }
            
            addMessage(message, 'user');
            messageInput.value = '';
            document.getElementById('sendButton').disabled = true;
            messageInput.disabled = true;
            showTypingIndicator();

            try {
                const response = await fetch(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ message: message })
                });
                const data = await response.json();

                hideTypingIndicator();

                if (response.ok) {
                    if (data.response_sequence && data.response_sequence.length > 0) {
                        for (let i = 0; i < data.response_sequence.length; i++) {
                            const msg = data.response_sequence[i];
                            await new Promise(resolve => setTimeout(resolve, i === 0 ? 100 : 800));
                            addMessage(msg.content, 'bot', msg.type);
                        }
                    } else {
                        showError('Server vr√°til pr√°zdnu odpoveƒè.');
                    }
                } else {
                    throw new Error(data.error || 'Nepodarilo sa z√≠ska≈• odpoveƒè zo servera');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showError('Chyba siete. Skontrolujte pripojenie a sk√∫ste to znova.');
                await checkConnection();
            } finally {
                hideTypingIndicator();
                if (isConnected) {
                    document.getElementById('sendButton').disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }
        }

        function addMessage(content, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const avatarSVG = sender === 'user'
                ? `<svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12A10,10,0,0,0,12,22A10,10,0,0,0,22,12A10,10,0,0,0,12,2ZM12,6a3,3,0,1,1-3,3A3,3,0,0,1,12,6Zm0,14a7,7,0,0,1-7-7c0-2.39,1.95-4.36,4.36-4.36h5.28C17.05,8.64,19,10.61,19,13A7,7,0,0,1,12,20Z"/></svg>`
                : `<svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,1,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg>`;
            
            messageDiv.innerHTML = `<div class="message-avatar">${avatarSVG}</div><div class="message-content">${content}</div>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showError(message) {
            const chatMessages = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `‚ùå ${message}`;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            setTimeout(() => { if (errorDiv.parentNode) errorDiv.remove(); }, 5000);
        }

        function showTypingIndicator() { document.getElementById('typingIndicator').style.display = 'flex'; }
        function hideTypingIndicator() { document.getElementById('typingIndicator').style.display = 'none'; }
        
        async function startNewSession() {
            if (!isConnected) return showError('Nie je mo≈æn√© pripoji≈• sa k serveru.');
            if (!confirm('Naozaj chcete zaƒça≈• nov√∫ konverz√°ciu?')) return;
            try {
                const response = await fetch(`${API_BASE_URL}/new-session`, { method: 'POST', credentials: 'include' });
                if (response.ok) {
                    document.getElementById('chatMessages').innerHTML = `<div class="welcome-message">Vitajte. V≈°etko, ƒço tu zdieƒæate, je d√¥vern√©.</div><div class="message bot"><div class="message-avatar"><svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2A10,10,0,0,0,2,12a9.89,9.89,0,0,0,2.3,6.32l-1.5,4.35a1,1,0,0,0,1.26,1.26l4.35-1.5A10,10,0,1,0,12,2Zm4,11H14.5a.5.5,0,0,1,0-1H16a1,1,0,0,1,0,2Zm-8,0H6.5a.5.5,0,0,1,0-1H8a1,1,0,0,1,0,2Zm5.5,3.5c-2.58,0-4.83-1.63-5.5-4h11C16.33,14.87,14.08,16.5,11.5,16.5Z"/></svg></div><div class="message-content">Dobr√Ω de≈à! Som tu, aby som v√°s poƒç√∫val a podporil. Ako sa dnes c√≠tite?</div></div>`;
                    addMessage('Nov√° konverz√°cia bola spusten√°. Som pripraven√Ω poƒç√∫va≈•.', 'bot');
                } else {
                    throw new Error('Nepodarilo sa zaƒça≈• nov√∫ konverz√°ciu');
                }
            } catch (error) {
                showError(error.message);
            }
        }
        
        // --- Breathing Exercise ---
        let breathingInterval;
        let breathingCurrentCycle = 0;
        let breathingTotalCycles = 5;
        let breathingTechnique = '478';
        let breathingPhase = 'ready'; // ready, countdown, inhale, hold, exhale
        let breathingPhaseTime = 0;
        let breathingIsRunning = false;
        let breathingIsPaused = false;
        const breathingTechniques = {
            '478': { name: '4-7-8 D√Ωchanie', phases: [{ name: 'inhale', duration: 4, instruction: 'Vd√Ωchnite nosom' }, { name: 'hold', duration: 7, instruction: 'Zadr≈æte dych' }, { name: 'exhale', duration: 8, instruction: 'Vyd√Ωchnite √∫stami' }] },
            'box': { name: 'Box D√Ωchanie', phases: [{ name: 'inhale', duration: 4, instruction: 'Vd√Ωchnite' }, { name: 'hold', duration: 4, instruction: 'Zadr≈æte dych' }, { name: 'exhale', duration: 4, instruction: 'Vyd√Ωchnite' }, { name: 'hold', duration: 4, instruction: 'Zadr≈æte dych' }] },
            'simple': { name: 'Hlbok√© D√Ωchanie', phases: [{ name: 'inhale', duration: 6, instruction: 'Hlboko sa nad√Ωchnite' }, { name: 'exhale', duration: 6, instruction: 'Pomaly vyd√Ωchnite' }] }
        };

        function startBreathingExercise() {
            document.getElementById('breathingOverlay').style.display = 'flex';
            resetBreathingExercise();
        }

        function closeBreathingExercise() {
            if (breathingInterval) clearInterval(breathingInterval);
            breathingInterval = null;
            document.getElementById('breathingOverlay').style.display = 'none';
        }

        function resetBreathingExercise() {
            if(breathingInterval) clearInterval(breathingInterval);
            breathingIsRunning = false;
            breathingIsPaused = false;
            breathingCurrentCycle = 0;
            updateBreathingDisplay('ready', 3);
            document.getElementById('startBreathingBtn').style.display = 'inline-block';
            document.getElementById('pauseBreathingBtn').style.display = 'none';
            document.getElementById('startBreathingBtn').textContent = 'Zaƒça≈•';
        }

        function startBreathingCycle() {
            if (breathingIsRunning && !breathingIsPaused) return;
            
            breathingIsRunning = true;
            breathingIsPaused = false;
            document.getElementById('startBreathingBtn').style.display = 'none';
            document.getElementById('pauseBreathingBtn').style.display = 'inline-block';
            document.getElementById('pauseBreathingBtn').textContent = 'Pauza';
            
            let countdown = 3;
            updateBreathingDisplay('countdown', countdown);
            const countdownInterval = setInterval(() => {
                countdown--;
                updateBreathingDisplay('countdown', countdown);
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    startBreathingPhases();
                }
            }, 1000);
        }
        
        function startBreathingPhases(isResuming = false) {
            let currentPhaseIndex;
            if (!isResuming) {
                breathingCurrentCycle = 1;
                currentPhaseIndex = 0;
            } else {
                 const phases = breathingTechniques[breathingTechnique].phases;
                 currentPhaseIndex = phases.findIndex(p => p.name === breathingPhase);
            }

            function runNextPhase() {
                const phases = breathingTechniques[breathingTechnique].phases;
                if (!phases || currentPhaseIndex >= phases.length) return;
                const phaseData = phases[currentPhaseIndex];
                breathingPhase = phaseData.name;
                breathingPhaseTime = phaseData.duration;
                updateBreathingDisplay(breathingPhase, breathingPhaseTime);

                breathingInterval = setInterval(() => {
                    breathingPhaseTime--;
                    updateBreathingDisplay(breathingPhase, breathingPhaseTime);

                    if (breathingPhaseTime <= 0) {
                        clearInterval(breathingInterval);
                        currentPhaseIndex++;
                        if (currentPhaseIndex >= phases.length) {
                            currentPhaseIndex = 0;
                            breathingCurrentCycle++;
                        }
                        if (breathingCurrentCycle > breathingTotalCycles) {
                            completeBreathingExercise();
                        } else {
                            runNextPhase();
                        }
                    }
                }, 1000);
            }
            runNextPhase();
        }

        function updateBreathingDisplay(phase, time) {
            const instructionsEl = document.getElementById('breathingInstructions');
            const counterEl = document.getElementById('breathingCounter');
            const circleEl = document.getElementById('breathingCircle');
            const progressFillEl = document.getElementById('breathingProgressFill');
            const progressTextEl = document.getElementById('breathingProgressText');

            if (phase === 'ready') {
                instructionsEl.textContent = 'Pripravte sa na zaƒçiatok cviƒçenia...';
                counterEl.textContent = '';
                circleEl.className = 'breathing-inner-circle';
                progressFillEl.style.width = '0%';
                progressTextEl.textContent = `Cyklus 0 z ${breathingTotalCycles}`;
            } else if (phase === 'countdown') {
                instructionsEl.textContent = 'Pripravte sa...';
                counterEl.textContent = time > 0 ? time : '≈†tart!';
            } else {
                const phaseData = breathingTechniques[breathingTechnique].phases.find(p => p.name === phase);
                if (!phaseData) return;
                instructionsEl.textContent = phaseData.instruction;
                counterEl.textContent = time > 0 ? time : '';
                circleEl.style.transitionDuration = `${phaseData.duration}s`;
                circleEl.className = `breathing-inner-circle ${phase}`;
                progressTextEl.textContent = `Cyklus ${breathingCurrentCycle} z ${breathingTotalCycles}`;
                const progressPercent = breathingCurrentCycle > 0 ? ((breathingCurrentCycle - 1) / breathingTotalCycles) * 100 : 0;
                progressFillEl.style.width = `${progressPercent}%`;
            }
        }

        function pauseBreathing() {
            if (breathingIsPaused) {
                breathingIsPaused = false;
                document.getElementById('pauseBreathingBtn').textContent = 'Pauza';
                startBreathingPhases(true);
            } else {
                clearInterval(breathingInterval);
                breathingIsPaused = true;
                document.getElementById('pauseBreathingBtn').textContent = 'Pokraƒçova≈•';
                document.getElementById('breathingInstructions').textContent = 'Cviƒçenie pozastaven√©';
            }
        }

        function completeBreathingExercise() {
            clearInterval(breathingInterval);
            breathingIsRunning = false;
            document.getElementById('breathingInstructions').textContent = 'Cviƒçenie dokonƒçen√©! V√Ωborne!';
            document.getElementById('breathingCounter').textContent = '‚úì';
            document.getElementById('breathingProgressFill').style.width = '100%';
            document.getElementById('pauseBreathingBtn').style.display = 'none';
            document.getElementById('startBreathingBtn').style.display = 'inline-block';
            document.getElementById('startBreathingBtn').textContent = 'Znova';
            setTimeout(closeBreathingExercise, 3000);
        }

        // --- PSS-10 ---
        const pssQuestions = [
            { text: "Ako ƒçasto ste boli rozru≈°en√Ω/√° kv√¥li nieƒçomu, ƒço sa stalo neƒçakane?" },
            { text: "Ako ƒçasto ste mali pocit, ≈æe nem√°te pod kontrolou d√¥le≈æit√© veci vo svojom ≈æivote?" },
            { text: "Ako ƒçasto ste sa c√≠tili nerv√≥zne a v strese?" },
            { text: "Ako ƒçasto ste mali pocit istoty vo svojej schopnosti zvl√°da≈• osobn√© probl√©my?" },
            { text: "Ako ƒçasto ste mali pocit, ≈æe veci id√∫ podƒæa va≈°ich predst√°v?" },
            { text: "Ako ƒçasto ste zistili, ≈æe nedok√°≈æete zvl√°dnu≈• v≈°etko, ƒço ste mali urobi≈•?" },
            { text: "Ako ƒçasto ste boli schopn√Ω/√° ovl√°da≈• podr√°≈ædenie vo svojom ≈æivote?" },
            { text: "Ako ƒçasto ste mali pocit, ≈æe m√°te v≈°etko pod kontrolou?" },
            { text: "Ako ƒçasto ste sa hnevali kv√¥li veciam, ktor√© ste nemohli ovplyvni≈•?" },
            { text: "Ako ƒçasto ste mali pocit, ≈æe sa v√°m hromadia ≈•a≈ækosti tak vysoko, ≈æe ich nedok√°≈æete prekona≈•?" }
        ];
        const pssReverseScoredIndices = [3, 4, 6, 7]; 
        const pssScaleOptions = [ { value: 0, text: "Nikdy" }, { value: 1, text: "Takmer nikdy" }, { value: 2, text: "Niekedy" }, { value: 3, text: "Pomerne ƒçasto" }, { value: 4, text: "Veƒæmi ƒçasto" }];

        function openPssAssessment() {
            document.getElementById('pssOverlay').style.display = 'flex';
            renderPssQuestions();
            document.getElementById('pssForm').style.display = 'block';
            document.getElementById('pssFormActions').style.display = 'flex';
            document.getElementById('pssResultContainer').style.display = 'none';
        }

        function closePssAssessment() {
            document.getElementById('pssOverlay').style.display = 'none';
        }

        function renderPssQuestions() {
            const container = document.getElementById('pssQuestionList');
            container.innerHTML = '';
            pssQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'pss-question';
                questionDiv.innerHTML = `<p>${index + 1}. ${q.text}</p><div class="pss-scale">${pssScaleOptions.map(opt => `<label><input type="radio" name="pss-q-${index}" value="${opt.value}" required> ${opt.text}</label>`).join('')}</div>`;
                container.appendChild(questionDiv);
            });
        }
        
        document.getElementById('pssForm').addEventListener('submit', function(e) {
            e.preventDefault();
            let score = 0;
            const totalQuestions = pssQuestions.length;
            let answeredCount = 0;

            for (let i = 0; i < totalQuestions; i++) {
                const selected = document.querySelector(`input[name="pss-q-${i}"]:checked`);
                if (selected) {
                    answeredCount++;
                    let value = parseInt(selected.value);
                    score += pssReverseScoredIndices.includes(i) ? (4 - value) : value;
                }
            }
            
            if (answeredCount < totalQuestions) {
                alert('Pros√≠m, odpovedzte na v≈°etky ot√°zky.');
                return;
            }
            
            stressData.unshift({ type: 'pss', date: new Date().toISOString(), dateStr: new Date().toLocaleDateString('sk-SK'), pssScore: score, timestamp: Date.now() });
            saveStressData();
            updateDashboard();
            showPssResult(score);
        });

        function showPssResult(score) {
            document.getElementById('pssFormActions').style.display = 'none';
            document.getElementById('pssResultContainer').style.display = 'block';
            document.getElementById('pssResultScore').textContent = score;
            let interpretation = 'Vysok√° √∫rove≈à vn√≠man√©ho stresu.';
            if (score <= 13) interpretation = 'N√≠zka √∫rove≈à vn√≠man√©ho stresu.';
            else if (score <= 26) interpretation = 'Mierna √∫rove≈à vn√≠man√©ho stresu.';
            document.getElementById('pssResultInterpretation').textContent = interpretation;
        }

        // --- Daily Stress Tracking Functions ---
        function startStressTracking() {
            document.getElementById('stressOverlay').style.display = 'flex';
            resetStressForm();
        }

        function closeStressTracking() {
            document.getElementById('stressOverlay').style.display = 'none';
        }

        function resetStressForm() {
            selectedStressLevel = null;
            selectedSleepLevel = null;
            document.querySelectorAll('#stressScale .stress-number, #sleepScale .stress-number').forEach(num => num.classList.remove('selected'));
            document.getElementById('stressSource').value = '';
        }
        
        function setupScales() {
            const stressScaleContainer = document.getElementById('stressScale');
            stressScaleContainer.innerHTML = Array.from({length: 10}, (_, i) => `<div class="stress-number" data-value="${i + 1}">${i + 1}</div>`).join('');
            stressScaleContainer.addEventListener('click', e => {
                if(e.target.classList.contains('stress-number')) {
                    stressScaleContainer.querySelectorAll('.stress-number').forEach(n => n.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedStressLevel = parseInt(e.target.dataset.value);
                }
            });

            const sleepScaleContainer = document.getElementById('sleepScale');
            sleepScaleContainer.innerHTML = Array.from({length: 5}, (_, i) => `<div class="stress-number" data-value="${i + 1}">${i + 1}</div>`).join('');
            sleepScaleContainer.addEventListener('click', e => {
                if(e.target.classList.contains('stress-number')) {
                    sleepScaleContainer.querySelectorAll('.stress-number').forEach(n => n.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedSleepLevel = parseInt(e.target.dataset.value);
                }
            });
        }

        document.getElementById('stressForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (selectedStressLevel === null) return alert('Pros√≠m, vyberte √∫rove≈à stresu.');
            if (selectedSleepLevel === null) return alert('Pros√≠m, vyberte kvalitu sp√°nku.');
            
            stressData.unshift({ type: 'daily', date: new Date().toISOString(), dateStr: new Date().toLocaleDateString('sk-SK'), stressLevel: selectedStressLevel, sleepLevel: selectedSleepLevel, stressSource: document.getElementById('stressSource').value.trim(), timestamp: Date.now() });
            saveStressData();
            updateDashboard();
            closeStressTracking();
        });


        // --- Data & Dashboard ---
        function loadStressData() {
            try {
                const saved = localStorage.getItem('stressTrackingData');
                stressData = saved ? JSON.parse(saved) : [];
            } catch (error) { console.error('Error loading stress data:', error); stressData = []; }
        }

        function saveStressData() {
            try {
                localStorage.setItem('stressTrackingData', JSON.stringify(stressData));
            } catch (error) { console.error('Error saving stress data:', error); }
        }

        function updateDashboard() {
            const dailyEntries = stressData.filter(e => e.type === 'daily');
            const pssEntries = stressData.filter(e => e.type === 'pss');

            const last7Days = dailyEntries.filter(e => (Date.now() - e.timestamp) < 7 * 24 * 60 * 60 * 1000);
            document.getElementById('avgStressLevel').textContent = last7Days.length > 0 ? (last7Days.reduce((s, e) => s + e.stressLevel, 0) / last7Days.length).toFixed(1) : '-';
            document.getElementById('lastPssScore').textContent = pssEntries.length > 0 ? pssEntries[0].pssScore : '-';
            document.getElementById('totalEntries').textContent = stressData.length;

            let streak = 0;
            const uniqueDays = [...new Set(dailyEntries.map(e => e.dateStr))];
            if (uniqueDays.length > 0) {
                for (let i = 0; i < 365; i++) {
                    const checkDate = new Date();
                    checkDate.setDate(checkDate.getDate() - i);
                    if (uniqueDays.includes(checkDate.toLocaleDateString('sk-SK'))) streak++;
                    else break;
                }
            }
            document.getElementById('streakDays').textContent = streak;
            
            updateStressHistory();
            updateChartPlaceholder();
        }

        function updateStressHistory() {
            const historyList = document.getElementById('stressHistoryList');
            const recentEntries = stressData.slice(0, 10);
            if (recentEntries.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">Zatiaƒæ ≈æiadne z√°znamy.</div>';
                return;
            }
            historyList.innerHTML = recentEntries.map(entry => {
                if (entry.type === 'daily') {
                    let scoreClass = entry.stressLevel >= 7 ? 'high' : (entry.stressLevel >= 4 ? 'medium' : 'low');
                    return `<div class="history-item"><div><div class="history-date">${entry.dateStr} (Denn√Ω)</div></div><div class="history-score ${scoreClass}">Stres: ${entry.stressLevel}/10</div></div>`;
                } else if (entry.type === 'pss') {
                    let scoreClass = entry.pssScore > 26 ? 'high' : (entry.pssScore > 13 ? 'medium' : 'low');
                    return `<div class="history-item"><div><div class="history-date">${entry.dateStr} (PSS-10)</div></div><div class="history-score ${scoreClass}">Sk√≥re: ${entry.pssScore}/40</div></div>`;
                }
            }).join('');
        }
        
        function updateChartPlaceholder() {
            const chartPlaceholder = document.getElementById('stressChart');
            const dailyEntries = stressData.filter(e => e.type === 'daily');
            if (dailyEntries.length < 2) {
                chartPlaceholder.textContent = `üìà Graf sa zobraz√≠ po aspo≈à 2 denn√Ωch z√°znamoch.`;
                return;
            }
            const avgStress = (dailyEntries.reduce((s, e) => s + e.stressLevel, 0) / dailyEntries.length).toFixed(1);
            chartPlaceholder.innerHTML = `<div style="text-align: center; padding: 20px;">Priemern√Ω denn√Ω stres: <b style="font-size: 24px;">${avgStress}</b></div>`;
        }

        function exportStressData() {
            if (stressData.length === 0) return alert('≈Ωiadne d√°ta na export.');
            const headers = ['Typ', 'Datum', 'Stress_Level(1-10)', 'Sleep_Level(1-5)', 'PSS_Score(0-40)', 'Poznamka'];
            const csvContent = [headers.join(','), ...stressData.map(e => [e.type, e.dateStr, e.stressLevel || '', e.sleepLevel || '', e.pssScore || '', `"${(e.stressSource || '').replace(/"/g, '""')}"`].join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `stress_data_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializ√°cia v≈°etk√Ωch ƒçast√≠ aplik√°cie
            checkConnection();
            connectionCheckInterval = setInterval(checkConnection, CHECK_CONNECTION_INTERVAL);
            loadStressData();
            setupScales();
            updateDashboard();

            // Navig√°cia
            const navButtons = document.querySelectorAll('.nav-btn');
            const views = document.querySelectorAll('.view');
            const headerTitle = document.getElementById('headerTitle');
            const headerSubtitle = document.getElementById('headerSubtitle');
            const newSessionBtn = document.querySelector('.new-session-btn');

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const viewId = button.dataset.view;
                    headerTitle.innerHTML = button.dataset.title;
                    headerSubtitle.textContent = button.dataset.subtitle;
                    views.forEach(view => view.classList.remove('active'));
                    document.getElementById(viewId).classList.add('active');
                    newSessionBtn.style.display = (viewId === 'chatView') ? 'flex' : 'none';
                    if (viewId === 'dashboardView') updateDashboard();
                });
            });

            // Chat form listener
            document.getElementById('chatForm').addEventListener('submit', sendMessage);

            // Breathing technique selector
            const techniqueButtons = document.querySelectorAll('.technique-btn');
            techniqueButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (breathingIsRunning) return;
                    techniqueButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    breathingTechnique = button.dataset.technique;
                    resetBreathingExercise();
                });
            });
        });
    </script>
</body>
</html>
